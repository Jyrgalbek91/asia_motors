var app;(()=>{"use strict";var e={7806:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(7252)),n=s(a(7174)),o=s(a(6898)),i=s(a(8577)),u=s(a(6376)),l=s(a(218)),d=s(a(5260)),c=s(a(3978)),m=s(a(4251)),f=s(a(2652)),_=a(4664),g=s(a(6799)),p=(0,r.default)();(async()=>{try{const e=d.default.PORT;p.use((0,i.default)(m.default)),p.use(f.default),p.use(c.default),p.use(r.default.json()),p.use((0,n.default)()),p.use((0,o.default)()),p.use((0,u.default)()),p.use(g.default),p.use("/",r.default.static("public")),p.use("/",l.default),p.listen(e,(async()=>{console.log("Application listening on port: ",e),await(0,_.connectionCheck)()}))}catch(e){console.log("error startServer: ",e.message)}})()},2945:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(4122));t.default=r.default},1235:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(1460)),n=s(a(8416)),o=s(a(6716)),i=s(a(5946)),u=s(a(5260)),l=s(a(5560)),d=u.default.FILE_POST_PATH;t.default=new class{async getPostByIdController(e,t){try{const{id:a}=e.query,s=Number(a),n=await r.default.getPostById(s);return n?t.status(200).json(n):t.status(404).json({message:"Новости или акции не найдены"})}catch(e){return console.error("error getNewsController: ",e.message),t.status(500).json({message:"Internal Server Error"})}}async getAllPostsController(e,t){try{const{id:a}=e.params,{page:s=1,offset:n=12}=e.query,o=Number(a),i=Number(s),u=Number(n);if(isNaN(i)||isNaN(u))return t.status(400).json({message:"Некорректные параметры"});const l=await r.default.getAllPosts(o,i,u);return l?t.status(200).json(l):t.status(404).json({message:"Новости не найдены"})}catch(e){return console.error("error getAllPostsController: ",e.message),t.status(500).json({message:"Internal Server Error"})}}async createController(e,t){var a;try{if(!(0,n.default)(e.body,o.default.postSchema))return t.status(400).json({message:"Неверный формат"});const{id_type:s,title:u,description:l,images:c}=e.body;if(!Number(null===(a=e.user)||void 0===a?void 0:a.id))return t.status(404).json({message:"У вас нет доступа"});const m=[];if(e.files&&e.files.images){const a=Array.isArray(e.files.images)?e.files.images:[e.files.images];for(const e of a){const a=await i.default.saveFile({path:d,fileName:e.name,sampleFile:e,type:"image"});if(a.error)return t.status(400).json({message:"Ошибка загрузки файла"});m.push(a.dbFileName)}}const f=await r.default.create(s,u,l,m.length>0?m:c);return f?t.status(200).json({message:"Пост успешно создан",result:f}):t.status(404).json({message:"Ошибка создания поста"})}catch(e){return console.error("Ошибка в createController: ",e.message),t.status(500).json({message:"Ошибка сервера"})}}async showImage(e,t){try{const a=e.params.fileName,s=d+a,r=await l.default.exists(s);return console.log(await l.default.exists(s)),r?t.sendFile(s):t.status(400).json({message:"Файл не найден"})}catch(e){return console.log("error showFile: ",e.message),t.status(500).json({message:"Ошибка сервера"})}}async deletePost(e,t){const{id_post:a}=e.params;return isNaN(Number(a))?t.status(400).json({message:"Неверный формат ID"}):await r.default.deletePostById(Number(a))?t.status(200).json({message:"Успешно удалено"}):t.status(500).json({message:"Ошибка при удалении"})}async updatePost(e,t){try{const{id_post:a}=e.params,s=e.body;if(isNaN(Number(a)))return t.status(400).json({message:"Неверный формат ID"});"string"==typeof s.images_to_delete&&(s.images_to_delete=s.images_to_delete.split(",").map((e=>Number(e.trim()))).filter((e=>!isNaN(e))));const n=[];if(e.files&&e.files.images){const a=Array.isArray(e.files.images)?e.files.images:[e.files.images];for(const e of a){const a=await i.default.saveFile({path:d,fileName:e.name,sampleFile:e,type:"image"});if(a.error)return t.status(400).json({message:"Ошибка загрузки файла"});n.push(a.dbFileName)}}return s.images=n.map((e=>({image_name:e}))),await r.default.updatePostById(Number(a),s)?t.status(200).json({message:"Успешно обновлено"}):t.status(500).json({message:"Ошибка обновления"})}catch(e){return console.error("Error in updatePost:",e),t.status(500).json({message:"Internal server error"})}}async similarArticlesController(e,t){try{const{id_type:a,title:s}=e.query,n=await r.default.similarArticles(Number(a),String(s));return n?t.status(200).json({message:"Успешно",data:n}):t.status(400).json({message:"Ошибка"})}catch(e){return console.log("error similarArticlesController: ",e.message),!1}}}},4122:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(7252)),n=s(a(1235)),o=s(a(780)),i=r.default.Router();i.get("/get/id",n.default.getPostByIdController),i.post("/create",o.default.isAdminToken,n.default.createController),i.get("/similar",n.default.similarArticlesController),i.get("/get/:id",n.default.getAllPostsController),i.get("/image_file/show/:fileName",n.default.showImage),i.delete("/delete/:id_post",n.default.deletePost),i.put("/update/:id_post",n.default.updatePost),t.default=i},6716:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default={postSchema:{type:"object",properties:{id_type:{type:"string",minLength:1,required:!0},title:{type:"string",minLength:6},description:{type:"string",minLength:6},images:{type:"array",items:{type:"string"}}}}}},1460:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(2003)),n=s(a(5260)),o=s(a(4664)),i=s(a(9896)),u=n.default.ALLOW_HOST,l=n.default.FILE_POST_URL,d=n.default.FILE_POST_PATH,c={getPostById:async function(e){try{const{error:t,rows:a}=await o.default.query("SELECT \n         p.id AS post_id, \n         p.id_type, \n         pt.type_name,\n         p.title, \n         p.description, \n         p.date, \n         p.updated_at, \n         p.active, \n         g.id_image, \n         g.image_name \n       FROM post p \n       JOIN image g ON p.id = g.id_post\n       JOIN post_type pt ON pt.id_post_type = p.id_type\n       WHERE p.id = $1;",[e]);return!t&&0!==a.length&&{id:a[0].post_id,id_type:a[0].id_type,type_name:a[0].type_name,title:a[0].title,description:a[0].description,date:a[0].date,updated_at:a[0].updated_at,active:a[0].active,images:a.map((e=>({id_image:e.id_image,image_name:e.image_name?`${u}${l}image-${e.image_name}`:null})))}}catch(e){return console.log("error getPostById: ",e.message),!1}},getAllPosts:async function(e,t,a){try{const s=a,r=(t-1)*a,{error:n,rows:i}=await o.default.query("SELECT \n          p.id, \n          p.id_type, \n          pt.type_name,\n          p.title, \n          p.description, \n          p.\"date\", \n          p.updated_at, \n          p.active,\n          ARRAY_AGG(JSON_BUILD_OBJECT('id', i.id_image, 'image_name', i.image_name)) AS images\n        FROM post p\n        JOIN image i ON i.id_post = p.id\n        JOIN post_type pt ON pt.id_post_type = p.id_type\n        WHERE p.active = true\n          AND p.id_type = $1\n        GROUP BY p.id, p.id_type, pt.type_name, p.title, p.description, p.\"date\", p.updated_at, p.active\n        ORDER BY p.updated_at DESC\n        LIMIT $2 OFFSET $3;",[e,s,r]);return!n&&i.map((e=>Object.assign(Object.assign({},e),{images:e.images.map((e=>Object.assign(Object.assign({},e),{image_name:e.image_name?`${u}${l}image-${e.image_name}`:null})))})))}catch(e){return console.log("error getAllPosts: ",e.message),!1}},create:async function(e,t,a,s){try{const r="",{error:n,rows:i}=await o.default.query("CALL p_insert_post($1, $2, $3, $4, $5);",[e,t,a,s,r]);return n?(console.error("Error while inserting post:",n),!1):i}catch(e){return console.error("Error in create:",e.message),!1}},deletePostById:async function(e){try{const{rows:t}=await o.default.query("SELECT image_name FROM image WHERE id_post = $1",[e]);return t.length>0&&(t.forEach((e=>{const t=r.default.join(`${d}image-${e.image_name}`);i.default.existsSync(t)&&i.default.unlinkSync(t)})),await o.default.query("DELETE FROM image WHERE id_post = $1",[e])),await o.default.query("DELETE FROM post WHERE id = $1",[e]),!0}catch(e){return console.error("Error deleting post and images:",e),!1}},updatePostById:async function(e,t){try{const{title:a,description:s,id_type:n,images_to_delete:u,images:l}=t,c=!0;let m=[],f=[];if(void 0!==a&&(m.push(`title = $${f.length+1}`),f.push(a)),void 0!==s&&(m.push(`description = $${f.length+1}`),f.push(s)),void 0!==n&&(m.push(`id_type = $${f.length+1}`),f.push(n)),m.push(`active = $${f.length+1}`),f.push(c),m.push("updated_at = NOW()"),m.length>0&&await o.default.query(`UPDATE post SET ${m.join(", ")} WHERE id = $${f.length+1}`,[...f,e]),u&&u.length>0){const{rows:e}=await o.default.query("SELECT image_name FROM image WHERE id_image = ANY($1)",[u]);e.forEach((e=>{const t=r.default.join(`${d}image-${e.image_name}`);i.default.existsSync(t)&&i.default.unlinkSync(t)})),await o.default.query("DELETE FROM image WHERE id_image = ANY($1)",[u])}if(l&&l.length>0){const t=l.map((t=>o.default.query("INSERT INTO image (id_post, image_name) VALUES ($1, $2)",[e,t.image_name])));await Promise.all(t)}return!0}catch(e){return console.error("Error updating post and images:",e),!1}},similarArticles:async function(e,t){try{const a=t.replace(/[^\w\sа-яА-Я]/g,"").split(" ").filter((e=>e.length>3)).join(" | "),{rows:s}=await o.default.query("SELECT p.id,\n              p.id_type,\n              p.title,\n              p.description,\n              p.\"date\",\n              p.updated_at,\n              p.active,\n              ARRAY_AGG(JSON_BUILD_OBJECT('id', i.id_image, 'image_name', i.image_name)) AS images\n       FROM post p\n       JOIN image i ON p.id = i.id_post\n       WHERE p.id_type = $1 \n         AND p.tsv_content @@ to_tsquery('russian', $2)\n       GROUP BY p.id, p.id_type, p.title, p.description, p.\"date\", p.updated_at, p.active\n       ORDER BY ts_rank(p.tsv_content, to_tsquery('russian', $2)) DESC\n       LIMIT 3;",[e,a]);return s.map((e=>Object.assign(Object.assign({},e),{images:e.images.map((e=>Object.assign(Object.assign({},e),{image_name:e.image_name?`${u}${l}image-${e.image_name}`:null})))})))}catch(e){return console.error("Error in similarArticles:",e.message),[]}}};t.default=c},6799:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=a(7252),n=s(a(5684)),o=s(a(2945)),i=s(a(7173)),u=s(a(5490)),l=(0,r.Router)().use("/user",n.default).use("/shared",u.default).use("/post",o.default).use("/vehicle",i.default);l.use(((e,t)=>{t.status(404).json({error:"API not found"})})),t.default=(0,r.Router)().use("/asia_motors/api",l)},780:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=a(4572),n=s(a(5260)),o=s(a(3481)),i=(e,t)=>(0,r.sendError)(e,t,!1,401),u={isAdminToken:async(e,t,a)=>await(async(e,t,a,s)=>{try{const r=e.headers.authorization;if("development"===n.default.NODE_ENV&&console.log("token: ",r),!r)return i(t,e.t("token.notFound"));const u=o.default.getTokenData(r);if(!u)return i(t,e.t("token.invalid"));const l=Date.now();if("development"===n.default.NODE_ENV&&(console.log(Object.assign({},u)),console.log("Token expiration: ",new Date(u.exp)),console.log("Current timestamp: ",new Date(l)),console.log("Is token valid: ",u.exp>l)),u.exp<=l)return i(t,e.t("token.expired"));const d=u.r.map((e=>e.id_role));return await(async(e,t)=>{const a=new Set(e);for(let e of t)if(a.has(e))return!0;return!1})(d,s)?(e.user=u,a()):i(t,e.t("token.permission"))}catch(a){return console.error("CheckToken error:",a.message),i(t,e.t("token.invalid"))}})(e,t,a,[1])};t.default=u},5946:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(5560)),n=a(3903),o={saveFile:async function({path:e,sampleFile:t,ALLOWED_EXTENSIONS:a=["pdf","jpg","jpeg","png"],type:s,allowTypePrefix:r=!0}){try{if(!t||!t.name)return console.error("Ошибка: файл не передан или имеет некорректную структуру"),{error:!0,dbFileName:""};const o=t.name.split(".").pop();if(!o)return{error:!0,dbFileName:""};if(!a.includes(o))return{error:!0,dbFileName:""};const i=`${(0,n.v4)()}.${o}`,u=`${e}${r?`${s}-`:""}${i}`;return await t.mv(u),{error:!1,dbFileName:i}}catch(e){return console.log("error saveFile: ",e.message),{error:!0,dbFileName:""}}},removeFile:async function(e,t){r.default.deleteFile(`${e}${t}`)}};t.default=o},5490:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(7912));t.default=r.default},2669:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(3594));t.default=new class{async getBrandController(e,t){try{const{id_type:a}=e.query,s=await r.default.getBrand(Number(a));return s?t.status(200).json({message:"Успешно",data:s}):t.status(404).json({message:"Ошибка"})}catch(e){return t.status(500).json({message:"Ошибка сервера"})}}async getModelController(e,t){try{const{id_brand:a}=e.query,s=Number(a),n=await r.default.getModel(s);return n?t.status(200).json({message:"Успешно",data:n}):t.status(404).json({message:"Ошибка"})}catch(e){return t.status(500).json({message:"Ошибка сервера"})}}async getCapacityController(e,t){try{const e=await r.default.getCapacity();return e?t.status(200).json({message:"Успешно",data:e}):t.status(404).json({message:"Ошибка"})}catch(e){return t.status(500).json({message:"Ошибка сервера"})}}async getBoxController(e,t){try{const e=await r.default.getBox();return e?t.status(200).json({message:"Успешно",data:e}):t.status(404).json({message:"Ошибка"})}catch(e){return t.status(500).json({message:"Ошибка сервера"})}}async getPostTypeController(e,t){try{const e=await r.default.getPostType();return e?t.status(200).json({message:"Успешно",data:e}):t.status(404).json({message:"Ошибка"})}catch(e){return t.status(500).json({message:"Ошибка сервера"})}}async getVehicleTypeController(e,t){try{const e=await r.default.getVehicleType();return e?t.status(200).json({message:"Успешно",data:e}):t.status(404).json({message:"Ошибка"})}catch(e){return t.status(500).json({message:"Ошибка сервера"})}}async getMassController(e,t){try{const e=await r.default.getMassType();return e?t.status(200).json({message:"Успешно",data:e}):t.status(404).json({message:"Ошибка"})}catch(e){return t.status(500).json({message:"Ошибка сервера"})}}async getBucketController(e,t){try{const e=await r.default.getBucketType();return e?t.status(200).json({message:"Успешно",data:e}):t.status(404).json({message:"Ошибка"})}catch(e){return t.status(500).json({message:"Ошибка сервера"})}}async getFuelController(e,t){try{const e=await r.default.getFuelType();return e?t.status(200).json({message:"Успешно",data:e}):t.status(404).json({message:"Ошибка"})}catch(e){return t.status(500).json({message:"Ошибка сервера"})}}async getPowerController(e,t){try{const e=await r.default.getPowerType();return e?t.status(200).json({message:"Успешно",data:e}):t.status(404).json({message:"Ошибка"})}catch(e){return t.status(500).json({message:"Ошибка сервера"})}}}},7912:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(7252)),n=s(a(2669)),o=r.default.Router();o.get("/brand",n.default.getBrandController),o.get("/model",n.default.getModelController),o.get("/capacity",n.default.getCapacityController),o.get("/box",n.default.getBoxController),o.get("/post-type",n.default.getPostTypeController),o.get("/vehicle-type",n.default.getVehicleTypeController),o.get("/exp-mass",n.default.getMassController),o.get("/bucket-volume",n.default.getMassController),o.get("/fuel",n.default.getFuelController),o.get("/power",n.default.getPowerController),t.default=o},3594:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(4664));t.default={getBrand:async function(e){try{const{rows:t,error:a}=await r.default.query("SELECT id_brand, brand_name FROM brand WHERE id_type = $1;",[e]);return!a&&t}catch(e){return console.log("error getBrand: ",e.message),!1}},getModel:async function(e){try{const{rows:t,error:a}=await r.default.query("SELECT id_model, model_name FROM model WHERE id_brand = $1;",[e]);return!a&&t}catch(e){return console.log("error getModel: ",e.message),!1}},getCapacity:async function(){try{const{rows:e,error:t}=await r.default.query("SELECT * FROM capacity;",[]);return!t&&e}catch(e){return console.log("error getCapacity: ",e.message),!1}},getBox:async function(){try{const{rows:e,error:t}=await r.default.query("SELECT * FROM box;",[]);return!t&&e}catch(e){return console.log("error getBox: ",e.message),!1}},getPostType:async function(){try{const{rows:e,error:t}=await r.default.query("SELECT * FROM post_type;",[]);return!t&&e}catch(e){return console.log("error getPostType: ",e.message),!1}},getVehicleType:async function(){try{const{rows:e,error:t}=await r.default.query("SELECT * FROM vehicle_type;",[]);return!t&&e}catch(e){return console.log("error getVehicleType: ",e.message),!1}},getMassType:async function(){try{const{rows:e,error:t}=await r.default.query("SELECT * FROM mass;",[]);return!t&&e}catch(e){return console.log("error getMassType: ",e.message),!1}},getBucketType:async function(){try{const{rows:e,error:t}=await r.default.query("SELECT * FROM bucket;",[]);return!t&&e}catch(e){return console.log("error getBucketType: ",e.message),!1}},getFuelType:async function(){try{const{rows:e,error:t}=await r.default.query("SELECT * FROM fuel;",[]);return!t&&e}catch(e){return console.log("error getFuelType: ",e.message),!1}},getPowerType:async function(){try{const{rows:e,error:t}=await r.default.query("SELECT * FROM power;",[]);return!t&&e}catch(e){return console.log("error getPowerType: ",e.message),!1}}}},5684:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(2828));t.default=r.default},5905:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=a(4572),n=s(a(8416)),o=s(a(5260)),i=s(a(3481)),u=s(a(5574)),l=s(a(3410));t.default=new class{async login(e,t){try{if(!(0,n.default)(e.body,l.default.loginSchema))return(0,r.sendError)(t,e.t("inValidFormat"));const{login:a,password:s}=e.body,d=await u.default.userLogin(a,s);if(d&&d.id){const a=Date.now()+60*parseInt(o.default.JWT_EXPIRE_HOURS)*60*1e3,s=Array.isArray(d.role)?d.role:[d.role],n=i.default.generateAccessToken({id:d.id,r:s,s:d.surname,n:d.name,exp:a});if(!n)return(0,r.sendError)(t,e.t("token.generateError"));if(d)return(0,r.sendSuccess)(t,e.t("success"),{id:d.id,r:s,s:d.surname,n:d.name,exp:a,token:n,tokenType:"Bearer",expiresIn:60*parseInt(o.default.JWT_EXPIRE_HOURS)})}return(0,r.sendError)(t,e.t("unauth"),!1,401)}catch(a){return console.log("error login: ",a.message),(0,r.sendError)(t,e.t("error"),!1,400)}}async recourse(e,t){try{const{name:a,phone:s,auto:r,release:n,mileage:o,recourse:i}=e.body,l=await u.default.saveRecourse(a,s,r,n,o,i);return l?t.status(200).json({message:"Успешно",data:l}):t.status(400).json({message:"Ошибка"})}catch(e){return console.log("error recourse: ",e.message),!1}}async getAllResourseController(e,t){try{const{page:a=1,offset:s=10}=e.query,r=Number(a),n=Number(s),o=await u.default.getAllResourse(r,n);return o?t.status(200).json({message:"Успешно",data:o}):t.status(400).json({message:"Ошибка"})}catch(e){return console.log("error getAllResourseController: ",e.message),!1}}async getResourseByIdController(e,t){try{const{id_service:a}=e.query,s=await u.default.getResourseById(Number(a));return s?t.status(200).json({message:"Успешно",data:s}):t.status(400).json({message:"Ошибка"})}catch(e){return console.log("error getResourseByIdController: ",e.message),!1}}async markAsRead(e,t){try{const{id:a}=e.params,s=await u.default.markAsRead(Number(a));return console.log(s),s?t.status(200).json({message:"Помечено как прочитанное",data:s}):t.status(404).json({message:"Запись не найдена"})}catch(e){return console.error("Error in markAsRead: ",e.message),t.status(500).json({message:"Ошибка при обновлении записи"})}}async feedback(e,t){try{const{name:a,phone:s,id_brand:r,id_model:n,wording:o}=e.body,i=await u.default.saveFeedback(a,s,r,n,o);return i?t.status(200).json({message:"Успешно",data:i}):t.status(400).json({message:"Ошибка"})}catch(e){return console.log("error feedback: ",e.message),!1}}async getAllFeedbackController(e,t){try{const{page:a=1,offset:s=10}=e.query,r=Number(a),n=Number(s),o=await u.default.getAllFeedback(r,n);return o?t.status(200).json({message:"Успешно",data:o}):t.status(400).json({message:"Ошибка"})}catch(e){return console.log("error getAllFeedbackController: ",e.message),!1}}async getFeedbackIdController(e,t){try{const{id_feedback:a}=e.query,s=await u.default.getFeedbackById(Number(a));return s?t.status(200).json({message:"Успешно",data:s}):t.status(400).json({message:"Ошибка"})}catch(e){return console.log("error getFeedbackIdController: ",e.message),!1}}}},2828:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(7252)),n=s(a(5905)),o=r.default.Router();o.post("/login",n.default.login),o.post("/recourse",n.default.recourse),o.get("/recourse/list",n.default.getAllResourseController),o.get("/recourse/id",n.default.getResourseByIdController),o.patch("/recourse/read/:id",n.default.markAsRead),o.post("/feedback",n.default.feedback),o.get("/feedback/list",n.default.getAllFeedbackController),o.get("/feedback/id",n.default.getFeedbackIdController),t.default=o},3410:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default={loginSchema:{type:"object",properties:{login:{type:["string","number"],required:!0,minLength:1},password:{type:"string",required:!0,minLength:1}}}}},5574:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=a(7265),n=s(a(4664)),o={userLogin:async function(e,t){try{const a=(0,r.md5)(t),{rows:s,rowCount:o}=await n.default.query("SELECT * FROM public.fn_auth($1, $2);",[e,a]);if(o&&o>0){const{id_user:e,roles:t,surname:a,name:r}=s[0];return{id:e,role:t,surname:a,name:r}}return!1}catch(e){return console.log("error userLogin: ",e.message),!1}},saveRecourse:async function(e,t,a,s,r,o){try{const{error:i,rows:u}=await n.default.query("INSERT INTO service(name, phone, auto, release, mileage, recourse)\n       VALUES($1, $2, $3, $4, $5, $6)\n       RETURNING id_service;",[e,t,a,s,r,o]);return!i&&u[0]}catch(e){return console.log("error saveRecourse: ",e.message),!1}},getAllResourse:async function(e,t){try{const a=t,s=(e-1)*t,{error:r,rows:o}=await n.default.query("SELECT * FROM service LIMIT $1 OFFSET $2;",[a,s]);return!r&&o}catch(e){return console.log("error getAllResourse: ",e.message),!1}},getResourseById:async function(e){try{const{error:t,rows:a}=await n.default.query("SELECT * FROM service WHERE id_service = $1;",[e]);return!t&&a[0]}catch(e){return console.log("error getResourseById: ",e.message),!1}},markAsRead:async function(e){try{const{error:t,rows:a}=await n.default.query("UPDATE service\n       SET active = false, date = CURRENT_TIMESTAMP\n       WHERE id_service = $1\n       RETURNING *;",[e]);return!t&&a[0]}catch(e){return console.log("error markAsRead: ",e.message),!1}},saveFeedback:async function(e,t,a,s,r){try{const{error:o,rows:i}=await n.default.query("INSERT INTO feedback(name, phone, id_brand, id_model, wording)\n       VALUES($1, $2, $3, $4, $5)\n       RETURNING id_feedback;",[e,t,a,s,r]);return!o&&i[0]}catch(e){return console.log("error saveFeedback: ",e.message),!1}},getAllFeedback:async function(e,t){try{const a=t,s=(e-1)*t,{error:r,rows:o}=await n.default.query('SELECT f.id_feedback, \n              f."name", \n              f.phone, \n              f.id_brand,\n              b.brand_name,\n              f.id_model,\n              m.model_name,\n              f.wording,\n              f"date",\n              f.active\n       FROM feedback f \n       LEFT JOIN brand b USING(id_brand)\n       LEFT JOIN model m USING(id_model)\n       LIMIT $1 OFFSET $2;',[a,s]);return!r&&o}catch(e){return console.log("error getAllFeedback: ",e.message),!1}},getFeedbackById:async function(e){try{const{error:t,rows:a}=await n.default.query('SELECT f.id_feedback, \n              f."name", \n              f.phone, \n              f.id_brand,\n              b.brand_name,\n              f.id_model,\n              m.model_name,\n              f.wording,\n              f"date",\n              f.active\n       FROM feedback f \n       LEFT JOIN brand b USING(id_brand)\n       LEFT JOIN model m USING(id_model)\n       WHERE id_feedback = $1;',[e]);return!t&&a[0]}catch(e){return console.log("error getFeedbackById: ",e.message),!1}}};t.default=o},5260:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),s(a(818)).default.config();const r=Number(process.env.PORT)||9e3,n=process.env.JWT_ACCESS_SECRET||"",o=process.env.JWT_EXPIRE_HOURS||"30h",i=process.env.DBUSER||"postgres",u=process.env.DBPASS||"postgres",l=process.env.DBSERVER||"localhost",d=process.env.DBPORT||5432,c=process.env.DBNAME||"hyundai",m=process.env.DBNAME2||"postgres",f=process.env.DBPG_MAX_CONNECTIONS||20,_=process.env.DBPG_IDLETIMEOUTMILLLIS||3e4,g=process.env.DBPG_CONNECTIONTIMEOUTMILLES||2e3,p=Number(process.env.ID_ADMIN_ROLE)||1,y=process.env.ALLOW_HOST||`http://localhost:${r}`,h={PORT:r,NODE_ENV:"production",JWT_ACCESS_SECRET:n,JWT_EXPIRE_HOURS:o,DBUSER:i,DBPASS:u,DBSERVER:l,DBPORT:d,DBNAME:c,DBNAME2:m,DBPG_MAX_CONNECTIONS:f,DBPG_IDLETIMEOUTMILLLIS:_,DBPG_CONNECTIONTIMEOUTMILLES:g,ALLOW_HOST:y,ALLOW_HOST_LIST:process.env.ALLOW_HOST_LIST?JSON.parse(process.env.ALLOW_HOST_LIST):[y],ID_ADMIN_ROLE:p,FILE_POST_PATH:process.env.FILE_POST_PATH||"",FILE_POST_URL:process.env.FILE_POST_URL||"",FILE_VEHICLE_PATH:process.env.FILE_VEHICLE_PATH||"",FILE_VEHICLE_URL:process.env.FILE_VEHICLE_URL||"",PDF_FILE_PATH:process.env.PDF_FILE_PATH||"",PDF_FILE_URL:process.env.PDF_FILE_URL||"",EMAIL_JWT_EXPIRE_HOURSE:process.env.EMAIL_JWT_EXPIRE_HOURSE||"1000h"};t.default=h},4251:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(5260));t.default=function(e,t){let a;a=-1!==r.default.ALLOW_HOST_LIST.indexOf(e.headers.origin||"")?{origin:!0,credentials:!0}:{origin:!1},t(null,a)}},9095:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(8749));var n=Buffer.from("3e10bb241d611ac910af5d8690011e6c","hex"),o=Buffer.from("34db16c275e2895654e798794f6e47ae","hex");const i="aes-128-cbc";t.default={encrypt:function(e){var t=r.default.createCipheriv(i,o,n);return t.update(e,"utf8","base64")+t.final("base64")},decrypt:function(e){var t=r.default.createDecipheriv(i,o,n);return t.update(e,"base64","utf8")+t.final("utf8")}}},4664:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.db=void 0,t.connectionCheck=async function(){try{return o.query("select 1 as answer;",[]).then((e=>{console.log("Connected to PG=>",e.rows[0]&&1==e.rows[0].answer)})).catch((e=>{throw console.error("Error executing query: ",e.stack),new Error(e)}))}catch(e){return{rows:[],rowCount:0,error:e.message}}},t.transaction=async function(e){const t=await o.connect();try{await t.query("BEGIN");const a=await e(t);return await t.query("COMMIT"),a}catch(e){throw await t.query("ROLLBACK"),e}finally{t.release()}};const r=a(2449),n=s(a(5260)),o=new r.Pool({host:n.default.DBSERVER,port:Number(n.default.DBPORT),database:n.default.DBNAME,user:n.default.DBUSER,password:n.default.DBPASS,max:Number(n.default.DBPG_MAX_CONNECTIONS),idleTimeoutMillis:Number(n.default.DBPG_IDLETIMEOUTMILLLIS),connectionTimeoutMillis:Number(n.default.DBPG_CONNECTIONTIMEOUTMILLES)});t.db=o,t.default={query:async function(e,t){try{"development"===n.default.NODE_ENV&&console.log("PG query: ",{text:e,params:t});const{rows:a,rowCount:s,command:r}=await o.query(e,t);return{rows:a,rowCount:s,error:!1,command:r}}catch(a){return console.log("PG ERROR=>",a),console.log("PG query: ",{text:e,params:t}),{rows:[],rowCount:0,error:a.message}}}}},2652:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const s=a(4572);t.default=(e,t,a,r)=>(console.log("errorHandler","=>",{url:t.url,error:e,tFunctionAvailable:"function"==typeof t.t}),(0,s.sendError)(a,null==e?void 0:e.message))},5560:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(9896)),n={exists:async e=>(console.log("Параметр filePath:",e),!!await r.default.promises.stat(e).catch((e=>("true"===process.env.DEBUG_MODE&&console.debug(e),!1)))),deleteFile:async e=>await r.default.promises.unlink(e).catch((e=>("true"===process.env.DEBUG_MODE&&console.debug(e),!1))),listDir:async e=>await r.default.promises.readdir(e).catch((e=>("true"===process.env.DEBUG_MODE&&console.debug(e),[]))),write:async(e,t)=>await r.default.promises.writeFile(e,t,"utf8"),read:async e=>await r.default.promises.readFile(e,"utf8")};t.default=n},218:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,a){if("/"===e.originalUrl)return t.redirect("/");const s=function(){let e=__dirname;for(;;){const t=r.default.join(e,"public");if(n.default.existsSync(t)&&n.default.statSync(t).isDirectory())return t;const a=r.default.dirname(e);if(a===e)break;e=a}return null}();return s?t.sendFile(r.default.join(s,"index.html")):t.status(404).send("Public directory not found")};const r=s(a(2003)),n=s(a(9896))},3978:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(6427)),n=s(a(8495)),o=s(a(1889)),i=s(a(970)),u=s(a(1725)),l={ru:{translation:i.default},kg:{translation:u.default}};r.default.use(n.default).use(o.default.LanguageDetector).init({resources:l,defaultNS:"translation",detection:{order:["querystring","cookie"],cache:["cookie"],lookupQuerystring:"lang",lookupCookie:"lang"},fallbackLng:["ru","kg","ky"],preload:["ru"]});const d=o.default.handle(r.default);t.default=d},3481:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(829)),n=s(a(9095)),o=s(a(5260)),i={generateAccessToken:e=>r.default.sign({data:n.default.encrypt(JSON.stringify(e))},o.default.JWT_ACCESS_SECRET,{expiresIn:o.default.JWT_EXPIRE_HOURS}),getTokenData:e=>{try{const t=e.split(" ");if("Bearer"!=t[0])return!1;const a=r.default.verify(t[1],o.default.JWT_ACCESS_SECRET);if(!a||!a.data)return!1;const s=JSON.parse(n.default.decrypt(a.data));return Object.assign({},s)}catch(e){return console.log("error getTokenData: ",e.message),!1}},generateLinkToken:(e,t=o.default.EMAIL_JWT_EXPIRE_HOURSE)=>r.default.sign({data:e},o.default.JWT_ACCESS_SECRET,{expiresIn:t}),getTokenDataLink:e=>{try{const t=r.default.verify(e,o.default.JWT_ACCESS_SECRET);if(!t||"object"!=typeof t||!t.data)return!1;const a=t.data;return Object.assign({},a)}catch(e){return console.log("error getTokenDataLink: ",e.message),!1}}};t.default=i},4572:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.sendSuccess=t.sendError=t.send=void 0;const a=(e,t,a,s,r)=>e.status(r).json({data:t,message:a,error:s});t.send=a,t.sendError=(e,t,s=!1,r=400)=>a(e,s,t,!0,r),t.sendSuccess=(e,t,s=!0,r=200)=>a(e,s,t,!1,r)},7265:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.md5=function(e){return r.default.createHash("md5").update(e).digest("hex")};const r=s(a(8749))},8416:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const s=a(5781);t.default=(e,t)=>(new s.Validator).validate(e,t).valid},7173:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(8456));t.default=r.default},7453:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(8416)),n=s(a(5946)),o=s(a(5260)),i=s(a(8998)),u=s(a(1722)),l=s(a(5560)),d=o.default.FILE_VEHICLE_PATH,c=o.default.PDF_FILE_PATH;t.default=new class{async createController(e,t){var a,s;try{if(!(0,r.default)(e.body,i.default.vehicleSchema))return t.status(400).json({message:"Неверный формат"});const{id_type:o,id_brand:l,id_model:m,id_capacity:f,id_box:_,description:g,images:p,id_mass:y,id_bucket:h}=e.body,E=""===f?null:f,b=""===_?null:_,v=""===y?null:y,N=""===h?null:h;if(!Number(null===(a=e.user)||void 0===a?void 0:a.id))return t.status(404).json({message:"У вас нет доступа"});const O=[];if(e.files&&e.files.images){const a=Array.isArray(e.files.images)?e.files.images:[e.files.images];for(const e of a){const a=await n.default.saveFile({path:d,fileName:e.name,sampleFile:e,type:"image"});if(a.error)return t.status(400).json({message:"Ошибка загрузки файла"});O.push(a.dbFileName)}}const w=null===(s=e.files)||void 0===s?void 0:s.pdf_file;if(!w)return t.status(400).json({message:"Файл отсутствует"});const I=Array.isArray(w)?w[0].name:w.name,{dbFileName:T,error:S}=await n.default.saveFile({path:c,fileName:I,sampleFile:Array.isArray(w)?w[0]:w,type:"file",allowTypePrefix:!1});if(S)return t.status(400).json({message:"Не удалось сохранить файл"});const j=await u.default.create(o,l,m,E,b,g,O.length>0?O:p,T,v,N);return j?t.status(200).json({message:"Успешно создано",result:j}):t.status(404).json({message:"Ошибка создания транспортных средств"})}catch(e){return console.error("Ошибка в createController: ",e.message),t.status(500).json({message:"Ошибка сервера"})}}async getVehicleByIdController(e,t){try{const{id:a}=e.query,s=Number(a),r=await u.default.getVehicleById(s);return r?t.status(200).json(r):t.status(404).json({message:"Транспортные средства не найдены"})}catch(e){return console.error("error getNewsController: ",e.message),t.status(500).json({message:"Internal Server Error"})}}async getAllVehicleController(e,t){try{const{id:a}=e.params,{page:s=1,offset:r=12,id_brand:n,id_model:o,id_capacity:i,id_box:l,id_mass:d,id_bucket:c}=e.query,m=Number(a),f=Number(s),_=Number(r);if(isNaN(f)||isNaN(_))return t.status(400).json({message:"Некорректные параметры"});const g={};n&&(g.id_brand=Number(n)),o&&(g.id_model=Number(o)),i&&(g.id_capacity=Number(i)),l&&(g.id_box=Number(l)),d&&(g.id_mass=Number(d)),c&&(g.id_bucket=Number(c));const p=await u.default.getAllVehicles(m,f,_,g);return p?t.status(200).json(p):t.status(404).json({message:"Транспортные средства не найдены"})}catch(e){return console.error("error getAllVehicleController: ",e.message),t.status(500).json({message:"Internal Server Error"})}}async showFile(e,t){try{const a=e.params.fileName,s=c+a,r=await l.default.exists(s);return console.log(await l.default.exists(s)),r?t.sendFile(s):t.status(400).json({message:"Файл не найден"})}catch(e){return console.log("error showFile: ",e.message),t.status(500).json({message:"Ошибка сервера"})}}async showImage(e,t){try{const a=e.params.fileName,s=d+a,r=await l.default.exists(s);return console.log(await l.default.exists(s)),r?t.sendFile(s):t.status(400).json({message:"Файл не найден"})}catch(e){return console.log("error showFile: ",e.message),t.status(500).json({message:"Ошибка сервера"})}}async deleteVehicle(e,t){const{id_vehicle:a}=e.params;return isNaN(Number(a))?t.status(400).json({message:"Неверный формат ID"}):await u.default.deleteVehicleById(Number(a))?t.status(200).json({message:"Успешно удалено"}):t.status(500).json({message:"Ошибка при удалении"})}async updateVehicle(e,t){var a;try{const{id_vehicle:s}=e.params,r=e.body;if(isNaN(Number(s)))return t.status(400).json({message:"Неверный формат ID"});"string"==typeof r.images_to_delete&&(r.images_to_delete=r.images_to_delete.split(",").map((e=>Number(e.trim()))).filter((e=>!isNaN(e))));const o=[];if(e.files&&e.files.images){const a=Array.isArray(e.files.images)?e.files.images:[e.files.images];for(const e of a){const a=await n.default.saveFile({path:d,fileName:e.name,sampleFile:e,type:"image"});if(a.error)return t.status(400).json({message:"Ошибка загрузки изображения"});o.push(a.dbFileName)}}let i=null;const l=null===(a=e.files)||void 0===a?void 0:a.pdf_file;if(l){const e=Array.isArray(l)?l[0].name:l.name,{dbFileName:a,error:s}=await n.default.saveFile({path:c,fileName:e,sampleFile:Array.isArray(l)?l[0]:l,type:"file",allowTypePrefix:!1});if(s)return t.status(400).json({message:"Ошибка обновления PDF-файла"});i=a}return r.images=o.map((e=>({image_name:e}))),i&&(r.pdf_file=i),["id_type","id_brand","id_model","id_capacity","id_box","id_mass","id_bucket"].forEach((e=>{""===r[e]||void 0===r[e]?r[e]=null:(r[e]=Number(r[e]),isNaN(r[e])&&(r[e]=null))})),await u.default.updateVehicleById(Number(s),r)?t.status(200).json({message:"Успешно обновлено"}):t.status(500).json({message:"Ошибка обновления"})}catch(e){return console.error("Error in updateVehicle:",e.message),t.status(500).json({message:"Internal server error"})}}}},8456:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(7252)),n=s(a(780)),o=s(a(7453)),i=r.default.Router();i.post("/create",n.default.isAdminToken,o.default.createController),i.get("/get/id",o.default.getVehicleByIdController),i.get("/get/:id",o.default.getAllVehicleController),i.get("/pdf_file/show/:fileName",o.default.showFile),i.get("/image_file/show/:fileName",o.default.showImage),i.delete("/delete/:id_vehicle",o.default.deleteVehicle),i.put("/update/:id_vehicle",o.default.updateVehicle),t.default=i},8998:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default={vehicleSchema:{type:"object",properties:{id_type:{type:"string",minLength:1,required:!0},id_brand:{type:"string",minLength:1,required:!0},id_model:{type:"string",minLength:1,required:!0},id_capacity:{type:"string"},id_box:{type:"string"},description:{type:"string",minLength:6},images:{type:"array",items:{type:"string"}},pdf_file:{type:"string"},id_mass:{type:"string"},id_bucket:{type:"string"}}}}},1722:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(2003)),n=s(a(5260)),o=s(a(4664)),i=s(a(9896)),u=n.default.ALLOW_HOST,l=n.default.PDF_FILE_PATH,d=n.default.PDF_FILE_URL,c=n.default.FILE_VEHICLE_URL,m=n.default.FILE_VEHICLE_PATH,f={create:async function(e,t,a,s,r,n,i,u,l,d){try{const c="",{error:m,rows:f}=await o.default.query("CALL p_insert_vehicle($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11);",[e,t,a,null!=s?s:null,null!=r?r:null,n,i,u,null!=l?l:null,null!=d?d:null,c]);return m?(console.error("Error while inserting post:",m),!1):f}catch(e){return console.error("Error in create:",e.message),!1}},getVehicleById:async function(e){try{const{error:t,rows:a}=await o.default.query("SELECT \n         v.id AS vehicle_id, \n         v.id_type, \n         vt.type_name,\n         v.id_brand, \n         b.brand_name,\n         v.id_model,\n         m.model_name,\n         v.id_capacity,\n         c.capacity_name,\n         v.id_box,\n         bx.box_name,\n         v.id_mass,\n         ms.mass_name,\n         v.id_bucket,\n         bc.bucket_name,\n         v.description, \n         v.date, \n         v.updated_at, \n         v.active, \n         g.id_image, \n         g.image_name \n       FROM vehicle v \n       JOIN image g ON v.id = g.id_vehicle\n       JOIN vehicle_type vt ON vt.id_vehicle_type = v.id_type\n       JOIN brand b USING(id_brand)\n       JOIN model m USING(id_model)\n       JOIN capacity c USING(id_capacity)\n       JOIN box bx USING(id_box)\n       JOIN mass ms USING(id_mass)\n       JOIN bucket bc USING(id_bucket)\n       WHERE v.id = $1;",[e]);return!t&&0!==a.length&&{id:a[0].vehicle_id,id_type:a[0].id_type,type_name:a[0].type_name,id_brand:a[0].id_brand,brand_name:a[0].brand_name,id_model:a[0].id_model,model_name:a[0].model_name,id_capacity:a[0].id_capacity,capacity_name:a[0].capacity_name,id_box:a[0].id_box,box_name:a[0].box_name,id_mass:a[0].id_mass,mass_name:a[0].mass_name,id_bucket:a[0].id_bucket,bucket_name:a[0].bucket_name,description:a[0].description,date:a[0].date,updated_at:a[0].updated_at,active:a[0].active,images:a.map((e=>({id_image:e.id_image,image_name:e.image_name?`${u}${c}image-${e.image_name}`:null})))}}catch(e){return console.log("error getVehicleById: ",e.message),!1}},getAllVehicles:async function(e,t,a,s){try{const r=a,n=(t-1)*a;let i="\n      SELECT \n        v.id, \n        v.id_type, \n        vt.type_name,\n        v.id_brand,\n        b.brand_name,\n        v.id_model,\n        m.model_name,\n        v.id_capacity,\n        c.capacity_name,\n        v.id_box,\n        bx.box_name, \n        v.id_mass,\n        mas.mass_name,\n        v.id_bucket,\n        buck.bucket_name,\n        v.description, \n        v.\"date\", \n        v.updated_at, \n        v.active,\n        ARRAY_AGG(JSON_BUILD_OBJECT('id', i.id_image, 'image_name', i.image_name)) AS images,\n        v.pdf_file\n      FROM vehicle v \n      JOIN image i ON i.id_vehicle = v.id \n      JOIN vehicle_type vt ON vt.id_vehicle_type = v.id_type \n      JOIN brand b USING(id_brand)\n      JOIN model m USING(id_model)\n      LEFT JOIN capacity c USING(id_capacity)\n      LEFT JOIN \"box\" bx USING(id_box)\n      LEFT JOIN mass mas USING(id_mass)\n      LEFT JOIN bucket buck USING(id_bucket)\n      WHERE v.active = true\n        AND v.id_type = $1\n    ";const l=[e];let m="";s.id_brand&&(m+=` AND v.id_brand = $${l.length+1}`,l.push(s.id_brand)),s.id_model&&(m+=` AND v.id_model = $${l.length+1}`,l.push(s.id_model)),s.id_capacity&&(m+=` AND v.id_capacity = $${l.length+1}`,l.push(s.id_capacity)),s.id_box&&(m+=` AND v.id_box = $${l.length+1}`,l.push(s.id_box)),s.id_mass&&(m+=` AND v.id_mass = $${l.length+1}`,l.push(s.id_mass)),s.id_bucket&&(m+=` AND v.id_bucket = $${l.length+1}`,l.push(s.id_bucket)),i+=m,i+=`\n      GROUP BY v.id,\n               v.id_type,\n               vt.type_name, \n               v.id_brand, \n               b.brand_name, \n               v.id_model, \n               m.model_name, \n               v.id_capacity, \n               c.capacity_name, \n               v.id_box, \n               bx.box_name,\n               v.id_mass,\n               mas.mass_name,\n               v.id_bucket,\n               buck.bucket_name, \n               v.description, \n               v."date", \n               v.updated_at, \n               v.active,\n               v.pdf_file\n      ORDER BY v.updated_at DESC\n      LIMIT $${l.length+1} OFFSET $${l.length+2};\n    `,l.push(r,n);const{error:f,rows:_}=await o.default.query(i,l);return!f&&_.map((e=>Object.assign(Object.assign({},e),{pdf_file:e.pdf_file?`${u}${d}${e.pdf_file}`:null,images:e.images.map((e=>Object.assign(Object.assign({},e),{image_name:e.image_name?`${u}${c}image-${e.image_name}`:null})))})))}catch(e){return console.log("error getAllVehicles: ",e.message),!1}},deleteVehicleById:async function(e){try{const{rows:t}=await o.default.query("SELECT pdf_file FROM vehicle WHERE id = $1",[e]);if(t.length>0&&t[0].pdf_file){const e=r.default.join(`${l}${t[0].pdf_file}`);i.default.existsSync(e)&&i.default.unlinkSync(e)}const{rows:a}=await o.default.query("SELECT image_name FROM image WHERE id_vehicle = $1",[e]);return a.length>0&&(a.forEach((e=>{const t=r.default.join(`${m}image-${e.image_name}`);i.default.existsSync(t)&&i.default.unlinkSync(t)})),await o.default.query("DELETE FROM image WHERE id_vehicle = $1",[e])),await o.default.query("DELETE FROM vehicle WHERE id = $1",[e]),!0}catch(e){return console.error("Error deleting vehicle, images, or pdf:",e),!1}},updateVehicleById:async function(e,t){try{const{id_type:a,id_brand:s,id_model:n,id_capacity:u,id_box:d,description:c,pdf_file:f,id_mass:_,id_bucket:g,images_to_delete:p}=t,y=!0;let h=null;const{rows:E}=await o.default.query("SELECT pdf_file FROM vehicle WHERE id = $1",[e]);E.length>0&&(h=E[0].pdf_file);let b=[],v=[];if(void 0!==a&&(b.push("id_type = $1"),v.push(a)),void 0!==s&&(b.push("id_brand = $2"),v.push(s)),void 0!==n&&(b.push("id_model = $3"),v.push(n)),void 0!==u&&(b.push("id_capacity = $4"),v.push(u)),void 0!==d&&(b.push("id_box = $5"),v.push(d)),void 0!==c&&(b.push("description = $6"),v.push(c)),void 0!==_&&(b.push("id_mass = $7"),v.push(_)),void 0!==g&&(b.push("id_bucket = $8"),v.push(g)),b.push("active = $9"),v.push(y),b.push("updated_at = NOW()"),await o.default.query(`UPDATE vehicle SET ${b.join(", ")} WHERE id = $${v.length+1}`,[...v,e]),f){if(h&&h!==f){const e=r.default.join(l,h);i.default.existsSync(e)&&i.default.unlinkSync(e)}await o.default.query("UPDATE vehicle SET pdf_file = $1 WHERE id = $2",[f,e])}if(p&&p.length>0){const{rows:e}=await o.default.query("SELECT image_name FROM image WHERE id_image = ANY($1)",[p]);e.forEach((e=>{const t=r.default.join(`${m}image-${e.image_name}`);i.default.existsSync(t)&&i.default.unlinkSync(t)})),await o.default.query("DELETE FROM image WHERE id_image = ANY($1)",[p])}if(t.images&&t.images.length>0){const a=t.images.map((t=>o.default.query("INSERT INTO image (id_vehicle, image_name) VALUES ($1, $2)",[e,t.image_name])));await Promise.all(a)}return!0}catch(e){return console.error("Error updating vehicle and images:",e),!1}}};t.default=f},7174:e=>{e.exports=require("compression")},6898:e=>{e.exports=require("cookie-parser")},8577:e=>{e.exports=require("cors")},8749:e=>{e.exports=require("crypto")},818:e=>{e.exports=require("dotenv")},7252:e=>{e.exports=require("express")},6376:e=>{e.exports=require("express-fileupload")},6427:e=>{e.exports=require("i18next")},1889:e=>{e.exports=require("i18next-http-middleware")},8495:e=>{e.exports=require("i18next-node-fs-backend")},5781:e=>{e.exports=require("jsonschema")},829:e=>{e.exports=require("jsonwebtoken")},2003:e=>{e.exports=require("path")},2449:e=>{e.exports=require("pg")},3903:e=>{e.exports=require("uuid")},9896:e=>{e.exports=require("fs")},1725:e=>{e.exports=JSON.parse('{"token":{"notFound":"Токен табылган жок!","invalid":"Токен жараксыз!","permission":"Маалыматты алууга уруксатыңыз жок!","expired":"Токендин мөөнөтү бүттү!","generateError":"Токен жаратуу болбой калды"},"success":"Ийгиликтүү!","error":"Ката!","unauth":"Логин же сырсөз туура эмес!","inValidFormat":"Маалыматтарды туура толтуруңуз!","noValidEmail":"Электрондук дарек туура эмес!","noToken":"Токен жок!","emailUsed":"Email колдонууда","userNotFound":"Колдонуучу табылган жок","emailAlreadyInUse":"Сиз мурунтан эле колдонуп жаткан электрондук почтага өзгөртө албайсыз","changedNumber":"Телефон номери ийгиликтүү өзгөртүлдү","couldNotChangeTheNumber":"Номерди өзгөртүү ишке ашкан жок","phoneAlreadyInUse":"Сиз мурунтан эле колдонуп жаткан телефон номерге өзгөртө албайсыз","passwordAlreadyInUse":"Сиз мурунтан эле колдонуп жүргөн сырсөздү алмаштыра албайсыз","changePassword":"Сырсөздү ийгиликтүү өзгөрттүңүз","couldNotChangeThePassword":"Сырсөз өзгөргөн жок","fileIsMissing":"Файл жок","fileNotFound":"Файл табылган жок!"}')},970:e=>{e.exports=JSON.parse('{"token":{"notFound":"Токен не найден!","invalid":"Токен недействительный!","permission":"У вас нет доступа!","expired":"Срок действия токена истек!","generateError":"Не удалось сгенерировать токен"},"success":"Успешно!","error":"Ошибка!","unauth":"Неправильный логин пароль!","inValidFormat":"Неверный формат данных!","noValidEmail":"Неверный адрес электронной почты!","noToken":"Нет токена!","emailUsed":"Email уже используется","userNotFound":"Пользователь не найден","emailAlreadyInUse":"Нельзя поменять на почту, которую вы уже используете","changedNumber":"Номер телефона успешно изменен","couldNotChangeTheNumber":"Не получилось изменить номер","phoneAlreadyInUse":"Нельзя поменять на номер, которую вы уже используете","passwordAlreadyInUse":"Нельзя поменять на тот же пароль, которую вы уже используете","changePassword":"Вы успешно поменяли пароль","couldNotChangeThePassword":"Не получилось поменять пароль","fileIsMissing":"Файл отсутствует","fileNotFound":"Файл не найден!"}')}},t={},a=function a(s){var r=t[s];if(void 0!==r)return r.exports;var n=t[s]={exports:{}};return e[s].call(n.exports,n,n.exports,a),n.exports}(7806);app=a})();