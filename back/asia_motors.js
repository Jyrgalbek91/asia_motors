var app;(()=>{"use strict";var e={7806:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(7252)),n=s(a(7174)),o=s(a(6898)),i=s(a(8577)),l=s(a(6376)),u=s(a(218)),d=s(a(5260)),c=s(a(3978)),f=s(a(4251)),m=s(a(2652)),_=a(4664),g=s(a(6799)),p=(0,r.default)();(async()=>{try{const e=d.default.PORT;p.use((0,i.default)(f.default)),p.use(m.default),p.use(c.default),p.use(r.default.json()),p.use((0,n.default)()),p.use((0,o.default)()),p.use((0,l.default)()),p.use(g.default),p.use("/",r.default.static("public")),p.use("/",u.default),p.listen(e,(async()=>{console.log("Application listening on port: ",e),await(0,_.connectionCheck)()}))}catch(e){console.log("error startServer: ",e.message)}})()},2945:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(4122));t.default=r.default},1235:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(1460)),n=s(a(8416)),o=s(a(6716)),i=s(a(5946)),l=s(a(5260)),u=s(a(5560)),d=s(a(3481)),c=l.default.FILE_POST_PATH;t.default=new class{async getPostByIdController(e,t){try{const{id:a}=e.query,s=Number(a),n=await r.default.getPostById(s);return n?t.status(200).json(n):t.status(404).json({message:"Новости или акции не найдены"})}catch(e){return console.error("error getNewsController: ",e.message),t.status(500).json({message:"Internal Server Error"})}}async getAllPostsController(e,t){try{const{id:a}=e.params,{page:s=1,offset:n=12}=e.query,o=Number(a),i=Number(s),l=Number(n);if(isNaN(i)||isNaN(l))return t.status(400).json({message:"Некорректные параметры"});const u=e.headers.authorization;let c=!1;if(u){const e=d.default.getTokenData(u);if(console.log(e),!1===e)return t.status(400).json({message:"Invalid or missing token"});c=(e.r||[]).some((e=>"ADMIN"===e.role_name))}console.log(c);const f=await r.default.getAllPosts(o,i,l,c);return f?t.status(200).json(f):t.status(404).json({message:"Новости не найдены"})}catch(e){return console.error("error getAllPostsController: ",e.message),t.status(500).json({message:"Internal Server Error"})}}async createController(e,t){var a;try{if(!(0,n.default)(e.body,o.default.postSchema))return t.status(400).json({message:"Неверный формат"});const{id_type:s,title:l,description:u,images:d,date:f}=e.body;if(!Number(null===(a=e.user)||void 0===a?void 0:a.id))return t.status(404).json({message:"У вас нет доступа"});const m=[];if(e.files&&e.files.images){const a=Array.isArray(e.files.images)?e.files.images:[e.files.images];for(const e of a){const a=await i.default.saveFile({path:c,fileName:e.name,sampleFile:e,type:"image"});if(a.error)return t.status(400).json({message:"Ошибка загрузки файла"});m.push(a.dbFileName)}}const _=f||(new Date).toISOString(),g=await r.default.create(s,l,u,m.length>0?m:d,_);return g?t.status(200).json({message:"Пост успешно создан",result:g}):t.status(404).json({message:"Ошибка создания поста"})}catch(e){return console.error("Ошибка в createController: ",e.message),t.status(500).json({message:"Ошибка сервера"})}}async showImage(e,t){try{const a=e.params.fileName,s=c+a,r=await u.default.exists(s);return console.log(await u.default.exists(s)),r?t.sendFile(s):t.status(400).json({message:"Файл не найден"})}catch(e){return console.log("error showFile: ",e.message),t.status(500).json({message:"Ошибка сервера"})}}async deletePost(e,t){const{id_post:a}=e.params;return isNaN(Number(a))?t.status(400).json({message:"Неверный формат ID"}):await r.default.deletePostById(Number(a))?t.status(200).json({message:"Успешно удалено"}):t.status(500).json({message:"Ошибка при удалении"})}async updatePost(e,t){try{const{id_post:a}=e.params,s=e.body;if(isNaN(Number(a)))return t.status(400).json({message:"Неверный формат ID"});if("string"==typeof s.images_to_delete&&(s.images_to_delete=s.images_to_delete.split(",").map((e=>Number(e.trim()))).filter((e=>!isNaN(e)))),s.date&&isNaN(Date.parse(s.date)))return t.status(400).json({message:"Неверный формат даты"});const n=[];if(e.files&&e.files.images){const a=Array.isArray(e.files.images)?e.files.images:[e.files.images];for(const e of a){const a=await i.default.saveFile({path:c,fileName:e.name,sampleFile:e,type:"image"});if(a.error)return t.status(400).json({message:"Ошибка загрузки файла"});n.push(a.dbFileName)}}return s.images=n.map((e=>({image_name:e}))),await r.default.updatePostById(Number(a),s)?t.status(200).json({message:"Успешно обновлено"}):t.status(500).json({message:"Ошибка обновления"})}catch(e){return console.error("Error in updatePost:",e),t.status(500).json({message:"Internal server error"})}}async similarArticlesController(e,t){try{const{id_type:a,title:s,id:n}=e.query,o=await r.default.similarArticles(Number(a),String(s),Number(n));return o?t.status(200).json({message:"Успешно",data:o}):t.status(400).json({message:"Ошибка"})}catch(e){return console.log("error similarArticlesController: ",e.message),!1}}}},4122:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(7252)),n=s(a(1235)),o=s(a(780)),i=r.default.Router();i.get("/get/id",n.default.getPostByIdController),i.post("/create",o.default.isAdminToken,n.default.createController),i.get("/similar",n.default.similarArticlesController),i.get("/get/:id",n.default.getAllPostsController),i.get("/image_file/show/:fileName",n.default.showImage),i.delete("/delete/:id_post",n.default.deletePost),i.put("/update/:id_post",n.default.updatePost),t.default=i},6716:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default={postSchema:{type:"object",properties:{id_type:{type:"string",minLength:1,required:!0},title:{type:"string",minLength:6},description:{type:"string",minLength:6},images:{type:"array",items:{type:"string"}}}}}},1460:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(2003)),n=s(a(5260)),o=s(a(4664)),i=s(a(9896)),l=n.default.ALLOW_HOST,u=n.default.FILE_POST_URL,d=n.default.FILE_POST_PATH,c={getPostById:async function(e){try{const{error:t,rows:a}=await o.default.query("SELECT \n         p.id AS post_id, \n         p.id_type, \n         pt.type_name,\n         p.title, \n         p.description, \n         p.date, \n         p.updated_at, \n         p.active, \n         g.id_image, \n         g.image_name \n       FROM post p \n       JOIN image g ON p.id = g.id_post\n       JOIN post_type pt ON pt.id_post_type = p.id_type\n       WHERE p.id = $1;",[e]);return!t&&0!==a.length&&{id:a[0].post_id,id_type:a[0].id_type,type_name:a[0].type_name,title:a[0].title,description:a[0].description,date:a[0].date,updated_at:a[0].updated_at,active:a[0].active,images:a.map((e=>({id_image:e.id_image,image_name:e.image_name?`${l}${u}image-${e.image_name}`:null})))}}catch(e){return console.log("error getPostById: ",e.message),!1}},getAllPosts:async function(e,t,a,s){try{const r=a,n=(t-1)*a,{error:i,rows:d}=await o.default.query("SELECT COUNT(*) AS total\n       FROM post \n       WHERE id_type = $1\n       "+(s?"":"AND active = true"),[e]);if(i||0===d.length)return!1;const c=parseInt(d[0].total,10),{error:f,rows:m}=await o.default.query(`SELECT \n          p.id, \n          p.id_type, \n          pt.type_name,\n          p.title, \n          p.description, \n          p."date", \n          p.updated_at, \n          p.active,\n          ARRAY_AGG(JSON_BUILD_OBJECT('id', i.id_image, 'image_name', i.image_name)) AS images\n        FROM post p\n        LEFT JOIN image i ON i.id_post = p.id\n        JOIN post_type pt ON pt.id_post_type = p.id_type\n        WHERE p.id_type = $1\n        ${s?"":"AND p.active = true"}  \n        GROUP BY p.id, p.id_type, pt.type_name, p.title, p.description, p."date", p.updated_at, p.active\n        ORDER BY p.updated_at DESC\n        LIMIT $2 OFFSET $3;`,[e,r,n]);return!f&&{data:m.map((e=>Object.assign(Object.assign({},e),{images:e.images.map((e=>Object.assign(Object.assign({},e),{image_name:e.image_name?`${l}${u}image-${e.image_name}`:null})))}))),total:c,currentPage:t,totalPages:Math.ceil(c/r)}}catch(e){return console.log("error getAllPosts: ",e.message),!1}},create:async function(e,t,a,s,r){try{const n="",{error:i,rows:l}=await o.default.query("CALL p_insert_post($1, $2, $3, $4, $5, $6);",[e,t,a,s,r,n]);return i?(console.error("Error while inserting post:",i),!1):l}catch(e){return console.error("Error in create:",e.message),!1}},deletePostById:async function(e){try{const{rows:t}=await o.default.query("SELECT image_name FROM image WHERE id_post = $1",[e]);return t.length>0&&(t.forEach((e=>{const t=r.default.join(`${d}image-${e.image_name}`);i.default.existsSync(t)&&i.default.unlinkSync(t)})),await o.default.query("DELETE FROM image WHERE id_post = $1",[e])),await o.default.query("DELETE FROM post WHERE id = $1",[e]),!0}catch(e){return console.error("Error deleting post and images:",e),!1}},updatePostById:async function(e,t){try{const{title:a,description:s,id_type:n,images_to_delete:l,images:u,active:c,date:f}=t;let m=[],_=[];void 0!==a&&(m.push(`title = $${_.length+1}`),_.push(a)),void 0!==s&&(m.push(`description = $${_.length+1}`),_.push(s)),void 0!==n&&(m.push(`id_type = $${_.length+1}`),_.push(n)),void 0!==f&&(m.push(`"date" = $${_.length+1}`),_.push(f));const g="false"!==c&&(c||!0);if(m.push(`active = $${_.length+1}`),_.push(g),m.length>0&&await o.default.query(`UPDATE post SET ${m.join(", ")} WHERE id = $${_.length+1}`,[..._,e]),l&&l.length>0){const{rows:e}=await o.default.query("SELECT image_name FROM image WHERE id_image = ANY($1)",[l]);e.forEach((e=>{const t=r.default.join(`${d}image-${e.image_name}`);i.default.existsSync(t)&&i.default.unlinkSync(t)})),await o.default.query("DELETE FROM image WHERE id_image = ANY($1)",[l])}if(u&&u.length>0){const t=u.map((t=>o.default.query("INSERT INTO image (id_post, image_name) VALUES ($1, $2)",[e,t.image_name])));await Promise.all(t)}return!0}catch(e){return console.error("Error updating post and images:",e),!1}},similarArticles:async function(e,t,a){try{const s=t.replace(/[^\w\sа-яА-Я]/g,"").split(" ").filter((e=>e.length>3)).join(" | "),{rows:r}=await o.default.query("SELECT p.id,\n              p.id_type,\n              p.title,\n              p.description,\n              p.\"date\",\n              p.updated_at,\n              p.active,\n              ARRAY_AGG(JSON_BUILD_OBJECT('id', i.id_image, 'image_name', i.image_name)) AS images\n       FROM post p\n       JOIN image i ON p.id = i.id_post\n       WHERE p.id_type = $1 \n         AND p.tsv_content @@ to_tsquery('russian', $2)\n         AND p.id != $3\n       GROUP BY p.id, p.id_type, p.title, p.description, p.\"date\", p.updated_at, p.active\n       ORDER BY ts_rank(p.tsv_content, to_tsquery('russian', $2)) DESC\n       LIMIT 3;",[e,s,a]);return r.map((e=>Object.assign(Object.assign({},e),{images:e.images.map((e=>Object.assign(Object.assign({},e),{image_name:e.image_name?`${l}${u}image-${e.image_name}`:null})))})))}catch(e){return console.error("Error in similarArticles:",e.message),[]}}};t.default=c},6799:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=a(7252),n=s(a(5684)),o=s(a(2945)),i=s(a(7173)),l=s(a(5490)),u=s(a(1636)),d=(0,r.Router)().use("/user",n.default).use("/shared",l.default).use("/post",o.default).use("/vehicle",i.default).use("/storage",u.default);d.use(((e,t)=>{t.status(404).json({error:"API not found"})})),t.default=(0,r.Router)().use("/asia_motors/api",d)},780:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=a(4572),n=s(a(5260)),o=s(a(3481)),i=(e,t)=>(0,r.sendError)(e,t,!1,401),l={isAdminToken:async(e,t,a)=>await(async(e,t,a,s)=>{try{const r=e.headers.authorization;if("development"===n.default.NODE_ENV&&console.log("token: ",r),!r)return i(t,e.t("token.notFound"));const l=o.default.getTokenData(r);if(!l)return i(t,e.t("token.invalid"));const u=Date.now();if("development"===n.default.NODE_ENV&&(console.log(Object.assign({},l)),console.log("Token expiration: ",new Date(l.exp)),console.log("Current timestamp: ",new Date(u)),console.log("Is token valid: ",l.exp>u)),l.exp<=u)return i(t,e.t("token.expired"));const d=l.r.map((e=>e.id_role));return await(async(e,t)=>{const a=new Set(e);for(let e of t)if(a.has(e))return!0;return!1})(d,s)?(e.user=l,a()):i(t,e.t("token.permission"))}catch(a){return console.error("CheckToken error:",a.message),i(t,e.t("token.invalid"))}})(e,t,a,[1])};t.default=l},5946:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(5560)),n=a(3903),o={saveFile:async function({path:e,sampleFile:t,ALLOWED_EXTENSIONS:a=["pdf","jpg","jpeg","png"],type:s,allowTypePrefix:r=!0}){try{if(!t||!t.name)return console.error("Ошибка: файл не передан или имеет некорректную структуру"),{error:!0,dbFileName:""};const o=t.name.split(".").pop();if(!o)return{error:!0,dbFileName:""};if(!a.includes(o))return{error:!0,dbFileName:""};const i=`${(0,n.v4)()}.${o}`,l=`${e}${r?`${s}-`:""}${i}`;return await t.mv(l),{error:!1,dbFileName:i}}catch(e){return console.log("error saveFile: ",e.message),{error:!0,dbFileName:""}}},removeFile:async function(e,t){r.default.deleteFile(`${e}${t}`)}};t.default=o},5490:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(7912));t.default=r.default},2669:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(3594));t.default=new class{async getBrandController(e,t){try{const{id_type:a}=e.query,s=await r.default.getBrand(a?Number(a):void 0);return s?t.status(200).json({message:"Успешно",data:s}):t.status(404).json({message:"Ошибка"})}catch(e){return t.status(500).json({message:"Ошибка сервера"})}}async getModelController(e,t){try{const{id_brand:a}=e.query,s=Number(a),n=await r.default.getModel(s);return n?t.status(200).json({message:"Успешно",data:n}):t.status(404).json({message:"Ошибка"})}catch(e){return t.status(500).json({message:"Ошибка сервера"})}}async getCapacityController(e,t){try{const e=await r.default.getCapacity();return e?t.status(200).json({message:"Успешно",data:e}):t.status(404).json({message:"Ошибка"})}catch(e){return t.status(500).json({message:"Ошибка сервера"})}}async getBoxController(e,t){try{const e=await r.default.getBox();return e?t.status(200).json({message:"Успешно",data:e}):t.status(404).json({message:"Ошибка"})}catch(e){return t.status(500).json({message:"Ошибка сервера"})}}async getPostTypeController(e,t){try{const e=await r.default.getPostType();return e?t.status(200).json({message:"Успешно",data:e}):t.status(404).json({message:"Ошибка"})}catch(e){return t.status(500).json({message:"Ошибка сервера"})}}async getVehicleTypeController(e,t){try{const e=await r.default.getVehicleType();return e?t.status(200).json({message:"Успешно",data:e}):t.status(404).json({message:"Ошибка"})}catch(e){return t.status(500).json({message:"Ошибка сервера"})}}async getMassController(e,t){try{const e=await r.default.getMassType();return e?t.status(200).json({message:"Успешно",data:e}):t.status(404).json({message:"Ошибка"})}catch(e){return t.status(500).json({message:"Ошибка сервера"})}}async getBucketController(e,t){try{const e=await r.default.getBucketType();return e?t.status(200).json({message:"Успешно",data:e}):t.status(404).json({message:"Ошибка"})}catch(e){return t.status(500).json({message:"Ошибка сервера"})}}async getFuelController(e,t){try{const e=await r.default.getFuelType();return e?t.status(200).json({message:"Успешно",data:e}):t.status(404).json({message:"Ошибка"})}catch(e){return t.status(500).json({message:"Ошибка сервера"})}}async getPowerController(e,t){try{const e=await r.default.getPowerType();return e?t.status(200).json({message:"Успешно",data:e}):t.status(404).json({message:"Ошибка"})}catch(e){return t.status(500).json({message:"Ошибка сервера"})}}async getBodyController(e,t){try{const e=await r.default.getBodyType();return e?t.status(200).json({message:"Успешно",data:e}):t.status(404).json({message:"Ошибка"})}catch(e){return t.status(500).json({message:"Ошибка сервера"})}}}},7912:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(7252)),n=s(a(2669)),o=r.default.Router();o.get("/brand",n.default.getBrandController),o.get("/model",n.default.getModelController),o.get("/capacity",n.default.getCapacityController),o.get("/box",n.default.getBoxController),o.get("/post-type",n.default.getPostTypeController),o.get("/vehicle-type",n.default.getVehicleTypeController),o.get("/exp-mass",n.default.getMassController),o.get("/bucket-volume",n.default.getBucketController),o.get("/fuel",n.default.getFuelController),o.get("/power",n.default.getPowerController),o.get("/body",n.default.getBodyController),t.default=o},3594:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(4664)),n={getBrand:async function(e){try{let t="SELECT id_brand, brand_name FROM brand";const a=[];e&&(t+=" WHERE id_type = $1",a.push(e));const{rows:s,error:n}=await r.default.query(t,a);return!n&&s}catch(e){return console.log("error getBrand: ",e.message),!1}},getModel:async function(e){try{const{rows:t,error:a}=await r.default.query("SELECT id_model, model_name FROM model WHERE id_brand = $1;",[e]);return!a&&t}catch(e){return console.log("error getModel: ",e.message),!1}},getCapacity:async function(){try{const{rows:e,error:t}=await r.default.query("SELECT * FROM capacity;",[]);return!t&&e}catch(e){return console.log("error getCapacity: ",e.message),!1}},getBox:async function(){try{const{rows:e,error:t}=await r.default.query("SELECT * FROM box;",[]);return!t&&e}catch(e){return console.log("error getBox: ",e.message),!1}},getPostType:async function(){try{const{rows:e,error:t}=await r.default.query("SELECT * FROM post_type;",[]);return!t&&e}catch(e){return console.log("error getPostType: ",e.message),!1}},getVehicleType:async function(){try{const{rows:e,error:t}=await r.default.query("SELECT * FROM vehicle_type;",[]);return!t&&e}catch(e){return console.log("error getVehicleType: ",e.message),!1}},getMassType:async function(){try{const{rows:e,error:t}=await r.default.query("SELECT * FROM mass;",[]);return!t&&e}catch(e){return console.log("error getMassType: ",e.message),!1}},getBucketType:async function(){try{const{rows:e,error:t}=await r.default.query("SELECT * FROM bucket;",[]);return!t&&e}catch(e){return console.log("error getBucketType: ",e.message),!1}},getFuelType:async function(){try{const{rows:e,error:t}=await r.default.query("SELECT * FROM fuel;",[]);return!t&&e}catch(e){return console.log("error getFuelType: ",e.message),!1}},getPowerType:async function(){try{const{rows:e,error:t}=await r.default.query("SELECT * FROM power;",[]);return!t&&e}catch(e){return console.log("error getPowerType: ",e.message),!1}},getBodyType:async function(){try{const{rows:e,error:t}=await r.default.query("SELECT * FROM body;",[]);return!t&&e}catch(e){return console.log("error getBodyType: ",e.message),!1}}};t.default=n},1636:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(144));t.default=r.default},5125:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(8162)),n=s(a(5946)),o=s(a(5260)),i=s(a(5560)),l=o.default.PDF_FILE_PATH;t.default=new class{async saveFilesController(e,t){var a;try{const{vehicle_name:s}=e.query,o=null===(a=e.files)||void 0===a?void 0:a.file_name;if(!o)return t.status(400).json({message:"Файл отсутствует"});const i=Array.isArray(o)?o[0].name:o.name,{dbFileName:u,error:d}=await n.default.saveFile({path:l,fileName:i,sampleFile:Array.isArray(o)?o[0]:o,type:"file",allowTypePrefix:!1});if(d)return t.status(400).json({message:"Не удалось сохранить файл"});const c=await r.default.saveFiles(String(s),u);return c?t.status(200).json({message:"Успешно сохранено!",data:c}):t.status(400).json({message:"Ошибка сохранения файла!"})}catch(e){return console.log("error saveFilesController: ",e.message),!1}}async updateFilesController(e,t){var a;try{const{id_file:s}=e.params,o=e.body;if(isNaN(Number(s)))return t.status(400).json({message:"Неверный формат ID"});let i=null;const u=null===(a=e.files)||void 0===a?void 0:a.file_name;if(u){const e=Array.isArray(u)?u[0].name:u.name,{dbFileName:a,error:s}=await n.default.saveFile({path:l,fileName:e,sampleFile:Array.isArray(u)?u[0]:u,type:"file",allowTypePrefix:!1});if(s)return t.status(400).json({message:"Ошибка обновления PDF-файла"});i=a}return i&&(o.file_name=i),await r.default.updateFiles(Number(s),o)?t.status(200).json({message:"Успешно обновлено"}):t.status(500).json({message:"Ошибка обновления"})}catch(e){return console.error("Error in updateVehicle:",e.message),t.status(500).json({message:"Internal server error"})}}async showFile(e,t){try{const a=e.params.fileName,s=l+a,r=await i.default.exists(s);return console.log(await i.default.exists(s)),r?t.sendFile(s):t.status(400).json({message:"Файл не найден"})}catch(e){return console.log("error showFile: ",e.message),t.status(500).json({message:"Ошибка сервера"})}}async deleteStorageController(e,t){const{id_file:a}=e.params;return console.log(a),isNaN(Number(a))?t.status(400).json({message:"Неверный формат ID"}):await r.default.deleteStorageById(Number(a))?t.status(200).json({message:"Успешно удалено"}):t.status(500).json({message:"Ошибка при удалении"})}async getFilesController(e,t){try{const{vehicle_name:a}=e.query,s=await r.default.getFiles(String(a));return s?t.status(200).json({message:"Успешно",data:s}):t.status(400).json({message:"Ошибка получения файла"})}catch(e){return console.log("error getFilesController: ",e.message),!1}}}},144:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(7252)),n=s(a(5125)),o=r.default.Router();o.post("/save",n.default.saveFilesController),o.get("/file",n.default.getFilesController),o.get("/pdf_file/show/:fileName",n.default.showFile),o.put("/update/:id_file",n.default.updateFilesController),o.delete("/delete/:id_file",n.default.deleteStorageController),t.default=o},8162:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(2003)),n=s(a(4664)),o=s(a(9896)),i=s(a(5260)),l=i.default.PDF_FILE_PATH,u=i.default.ALLOW_HOST,d=i.default.PDF_FILE_URL,c={saveFiles:async function(e,t){try{const{error:a,rows:s}=await n.default.query("INSERT INTO files(vehicle_name, file_name)\n             VALUES($1, $2)\n             RETURNING id_file;",[e,t]);return!a&&s}catch(e){return console.log("error saveFiles: ",e.message),!1}},updateFiles:async function(e,t){try{const{file_name:a}=t;let s=null,i=null;const{rows:u}=await n.default.query("SELECT file_name FROM files WHERE id_file = $1",[e]);if(u.length>0&&(s=u[0].file_name),a){if(s&&s!==a){const e=r.default.join(l,s);o.default.existsSync(e)&&o.default.unlinkSync(e)}i=await n.default.query("UPDATE files SET file_name = $1 WHERE id_file = $2",[a,e])}return i}catch(e){return console.log("error updateFiles: ",e.message),!1}},deleteStorageById:async function(e){try{const{rows:t}=await n.default.query("SELECT file_name FROM files WHERE id_file = $1",[e]);if(t.length>0&&t[0].file_name){const e=r.default.join(`${l}${t[0].file_name}`);o.default.existsSync(e)&&o.default.unlinkSync(e)}return await n.default.query("DELETE FROM files WHERE id_file = $1",[e]),!0}catch(e){return console.error("Error deleting pdf:",e),!1}},getFiles:async function(e){try{const{error:t,rows:a}=await n.default.query("SELECT id_file, file_name FROM files\n       WHERE vehicle_name = $1;",[e]);return!t&&a.map((e=>Object.assign(Object.assign({},e),{file_name:`${u}${d}${e.file_name}`})))}catch(e){return console.log("error getFiles: ",e.message),!1}}};t.default=c},5684:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(2828));t.default=r.default},5905:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=a(4572),n=s(a(8416)),o=s(a(5260)),i=s(a(3481)),l=s(a(5574)),u=s(a(3410));t.default=new class{async login(e,t){try{if(!(0,n.default)(e.body,u.default.loginSchema))return(0,r.sendError)(t,e.t("inValidFormat"));const{login:a,password:s}=e.body,d=await l.default.userLogin(a,s);if(d&&d.id){const a=Date.now()+60*parseInt(o.default.JWT_EXPIRE_HOURS)*60*1e3,s=Array.isArray(d.role)?d.role:[d.role],n=i.default.generateAccessToken({id:d.id,r:s,s:d.surname,n:d.name,exp:a});if(!n)return(0,r.sendError)(t,e.t("token.generateError"));if(d)return(0,r.sendSuccess)(t,e.t("success"),{id:d.id,r:s,s:d.surname,n:d.name,exp:a,token:n,tokenType:"Bearer",expiresIn:60*parseInt(o.default.JWT_EXPIRE_HOURS)})}return(0,r.sendError)(t,e.t("unauth"),!1,401)}catch(a){return console.log("error login: ",a.message),(0,r.sendError)(t,e.t("error"),!1,400)}}async recourse(e,t){try{const{name:a,phone:s,auto:r,release:n,mileage:o,recourse:i}=e.body,u=await l.default.saveRecourse(a,s,r,n,o,i);return u?t.status(200).json({message:"Успешно",data:u}):t.status(400).json({message:"Ошибка"})}catch(e){return console.log("error recourse: ",e.message),!1}}async getAllResourseController(e,t){try{const{page:a=1,offset:s=10}=e.query,r=Number(a),n=Number(s),o=await l.default.getAllResourse(r,n);return o?t.status(200).json({message:"Успешно",data:o}):t.status(400).json({message:"Ошибка"})}catch(e){return console.log("error getAllResourseController: ",e.message),!1}}async getResourseByIdController(e,t){try{const{id_service:a}=e.query,s=await l.default.getResourseById(Number(a));return s?t.status(200).json({message:"Успешно",data:s}):t.status(400).json({message:"Ошибка"})}catch(e){return console.log("error getResourseByIdController: ",e.message),!1}}async markAsRead(e,t){try{const{id:a}=e.params,s=await l.default.markAsRead(Number(a));return console.log(s),s?t.status(200).json({message:"Помечено как прочитанное",data:s}):t.status(404).json({message:"Запись не найдена"})}catch(e){return console.error("Error in markAsRead: ",e.message),t.status(500).json({message:"Ошибка при обновлении записи"})}}async feedback(e,t){try{const{name:a,phone:s,id_brand:r,id_model:n,wording:o}=e.body,i=await l.default.saveFeedback(a,s,r,n,o);return i?t.status(200).json({message:"Успешно",data:i}):t.status(400).json({message:"Ошибка"})}catch(e){return console.log("error feedback: ",e.message),!1}}async getAllFeedbackController(e,t){try{const{page:a=1,offset:s=10}=e.query,r=Number(a),n=Number(s),o=await l.default.getAllFeedback(r,n);return o?t.status(200).json({message:"Успешно",data:o}):t.status(400).json({message:"Ошибка"})}catch(e){return console.log("error getAllFeedbackController: ",e.message),!1}}async getFeedbackIdController(e,t){try{const{id_feedback:a}=e.query,s=await l.default.getFeedbackById(Number(a));return s?t.status(200).json({message:"Успешно",data:s}):t.status(400).json({message:"Ошибка"})}catch(e){return console.log("error getFeedbackIdController: ",e.message),!1}}}},2828:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(7252)),n=s(a(5905)),o=r.default.Router();o.post("/login",n.default.login),o.post("/recourse",n.default.recourse),o.get("/recourse/list",n.default.getAllResourseController),o.get("/recourse/id",n.default.getResourseByIdController),o.patch("/recourse/read/:id",n.default.markAsRead),o.post("/feedback",n.default.feedback),o.get("/feedback/list",n.default.getAllFeedbackController),o.get("/feedback/id",n.default.getFeedbackIdController),t.default=o},3410:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default={loginSchema:{type:"object",properties:{login:{type:["string","number"],required:!0,minLength:1},password:{type:"string",required:!0,minLength:1}}}}},5574:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=a(7265),n=s(a(4664)),o={userLogin:async function(e,t){try{const a=(0,r.md5)(t),{rows:s,rowCount:o}=await n.default.query("SELECT * FROM public.fn_auth($1, $2);",[e,a]);if(o&&o>0){const{id_user:e,roles:t,surname:a,name:r}=s[0];return{id:e,role:t,surname:a,name:r}}return!1}catch(e){return console.log("error userLogin: ",e.message),!1}},saveRecourse:async function(e,t,a,s,r,o){try{const{error:i,rows:l}=await n.default.query("INSERT INTO service(name, phone, auto, release, mileage, recourse)\n       VALUES($1, $2, $3, $4, $5, $6)\n       RETURNING id_service;",[e,t,a,s,r,o]);return!i&&l[0]}catch(e){return console.log("error saveRecourse: ",e.message),!1}},getAllResourse:async function(e,t){try{const a=t,s=(e-1)*t,{error:r,rows:o}=await n.default.query("SELECT * FROM service LIMIT $1 OFFSET $2;",[a,s]);return!r&&o}catch(e){return console.log("error getAllResourse: ",e.message),!1}},getResourseById:async function(e){try{const{error:t,rows:a}=await n.default.query("SELECT * FROM service WHERE id_service = $1;",[e]);return!t&&a[0]}catch(e){return console.log("error getResourseById: ",e.message),!1}},markAsRead:async function(e){try{const{error:t,rows:a}=await n.default.query("UPDATE service\n       SET active = false, date = CURRENT_TIMESTAMP\n       WHERE id_service = $1\n       RETURNING *;",[e]);return!t&&a[0]}catch(e){return console.log("error markAsRead: ",e.message),!1}},saveFeedback:async function(e,t,a,s,r){try{const{error:o,rows:i}=await n.default.query("INSERT INTO feedback(name, phone, id_brand, id_model, wording)\n       VALUES($1, $2, $3, $4, $5)\n       RETURNING id_feedback;",[e,t,a,s,r]);return!o&&i[0]}catch(e){return console.log("error saveFeedback: ",e.message),!1}},getAllFeedback:async function(e,t){try{const a=t,s=(e-1)*t,{error:r,rows:o}=await n.default.query('SELECT f.id_feedback, \n              f."name", \n              f.phone, \n              f.id_brand,\n              b.brand_name,\n              f.id_model,\n              m.model_name,\n              f.wording,\n              f"date",\n              f.active\n       FROM feedback f \n       LEFT JOIN brand b USING(id_brand)\n       LEFT JOIN model m USING(id_model)\n       LIMIT $1 OFFSET $2;',[a,s]);return!r&&o}catch(e){return console.log("error getAllFeedback: ",e.message),!1}},getFeedbackById:async function(e){try{const{error:t,rows:a}=await n.default.query('SELECT f.id_feedback, \n              f."name", \n              f.phone, \n              f.id_brand,\n              b.brand_name,\n              f.id_model,\n              m.model_name,\n              f.wording,\n              f"date",\n              f.active\n       FROM feedback f \n       LEFT JOIN brand b USING(id_brand)\n       LEFT JOIN model m USING(id_model)\n       WHERE id_feedback = $1;',[e]);return!t&&a[0]}catch(e){return console.log("error getFeedbackById: ",e.message),!1}}};t.default=o},5260:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),s(a(818)).default.config();const r=Number(process.env.PORT)||9e3,n=process.env.JWT_ACCESS_SECRET||"",o=process.env.JWT_EXPIRE_HOURS||"30h",i=process.env.DBUSER||"postgres",l=process.env.DBPASS||"postgres",u=process.env.DBSERVER||"localhost",d=process.env.DBPORT||5432,c=process.env.DBNAME||"hyundai",f=process.env.DBNAME2||"postgres",m=process.env.DBPG_MAX_CONNECTIONS||20,_=process.env.DBPG_IDLETIMEOUTMILLLIS||3e4,g=process.env.DBPG_CONNECTIONTIMEOUTMILLES||2e3,p=Number(process.env.ID_ADMIN_ROLE)||1,y=process.env.ALLOW_HOST||`http://localhost:${r}`,h={PORT:r,NODE_ENV:"production",JWT_ACCESS_SECRET:n,JWT_EXPIRE_HOURS:o,DBUSER:i,DBPASS:l,DBSERVER:u,DBPORT:d,DBNAME:c,DBNAME2:f,DBPG_MAX_CONNECTIONS:m,DBPG_IDLETIMEOUTMILLLIS:_,DBPG_CONNECTIONTIMEOUTMILLES:g,ALLOW_HOST:y,ALLOW_HOST_LIST:process.env.ALLOW_HOST_LIST?JSON.parse(process.env.ALLOW_HOST_LIST):[y],ID_ADMIN_ROLE:p,FILE_POST_PATH:process.env.FILE_POST_PATH||"",FILE_POST_URL:process.env.FILE_POST_URL||"",FILE_VEHICLE_PATH:process.env.FILE_VEHICLE_PATH||"",FILE_VEHICLE_URL:process.env.FILE_VEHICLE_URL||"",PDF_FILE_PATH:process.env.PDF_FILE_PATH||"",PDF_FILE_URL:process.env.PDF_FILE_URL||"",EMAIL_JWT_EXPIRE_HOURSE:process.env.EMAIL_JWT_EXPIRE_HOURSE||"1000h"};t.default=h},4251:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(5260));t.default=function(e,t){let a;a=-1!==r.default.ALLOW_HOST_LIST.indexOf(e.headers.origin||"")?{origin:!0,credentials:!0}:{origin:!1},t(null,a)}},9095:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(8749));var n=Buffer.from("3e10bb241d611ac910af5d8690011e6c","hex"),o=Buffer.from("34db16c275e2895654e798794f6e47ae","hex");const i="aes-128-cbc";t.default={encrypt:function(e){var t=r.default.createCipheriv(i,o,n);return t.update(e,"utf8","base64")+t.final("base64")},decrypt:function(e){var t=r.default.createDecipheriv(i,o,n);return t.update(e,"base64","utf8")+t.final("utf8")}}},4664:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.db=void 0,t.connectionCheck=async function(){try{return o.query("select 1 as answer;",[]).then((e=>{console.log("Connected to PG=>",e.rows[0]&&1==e.rows[0].answer)})).catch((e=>{throw console.error("Error executing query: ",e.stack),new Error(e)}))}catch(e){return{rows:[],rowCount:0,error:e.message}}},t.transaction=async function(e){const t=await o.connect();try{await t.query("BEGIN");const a=await e(t);return await t.query("COMMIT"),a}catch(e){throw await t.query("ROLLBACK"),e}finally{t.release()}};const r=a(2449),n=s(a(5260)),o=new r.Pool({host:n.default.DBSERVER,port:Number(n.default.DBPORT),database:n.default.DBNAME,user:n.default.DBUSER,password:n.default.DBPASS,max:Number(n.default.DBPG_MAX_CONNECTIONS),idleTimeoutMillis:Number(n.default.DBPG_IDLETIMEOUTMILLLIS),connectionTimeoutMillis:Number(n.default.DBPG_CONNECTIONTIMEOUTMILLES)});t.db=o,t.default={query:async function(e,t){try{"development"===n.default.NODE_ENV&&console.log("PG query: ",{text:e,params:t});const{rows:a,rowCount:s,command:r}=await o.query(e,t);return{rows:a,rowCount:s,error:!1,command:r}}catch(a){return console.log("PG ERROR=>",a),console.log("PG query: ",{text:e,params:t}),{rows:[],rowCount:0,error:a.message}}}}},2652:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const s=a(4572);t.default=(e,t,a,r)=>(console.log("errorHandler","=>",{url:t.url,error:e,tFunctionAvailable:"function"==typeof t.t}),(0,s.sendError)(a,null==e?void 0:e.message))},5560:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(9896)),n={exists:async e=>!!await r.default.promises.stat(e).catch((e=>("true"===process.env.DEBUG_MODE&&console.debug(e),!1))),deleteFile:async e=>await r.default.promises.unlink(e).catch((e=>("true"===process.env.DEBUG_MODE&&console.debug(e),!1))),listDir:async e=>await r.default.promises.readdir(e).catch((e=>("true"===process.env.DEBUG_MODE&&console.debug(e),[]))),write:async(e,t)=>await r.default.promises.writeFile(e,t,"utf8"),read:async e=>await r.default.promises.readFile(e,"utf8")};t.default=n},218:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,a){if("/"===e.originalUrl)return t.redirect("/");const s=function(){let e=__dirname;for(;;){const t=r.default.join(e,"public");if(n.default.existsSync(t)&&n.default.statSync(t).isDirectory())return t;const a=r.default.dirname(e);if(a===e)break;e=a}return null}();return s?t.sendFile(r.default.join(s,"index.html")):t.status(404).send("Public directory not found")};const r=s(a(2003)),n=s(a(9896))},3978:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(6427)),n=s(a(8495)),o=s(a(1889)),i=s(a(970)),l=s(a(1725)),u={ru:{translation:i.default},kg:{translation:l.default}};r.default.use(n.default).use(o.default.LanguageDetector).init({resources:u,defaultNS:"translation",detection:{order:["querystring","cookie"],cache:["cookie"],lookupQuerystring:"lang",lookupCookie:"lang"},fallbackLng:["ru","kg","ky"],preload:["ru"]});const d=o.default.handle(r.default);t.default=d},3481:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(829)),n=s(a(9095)),o=s(a(5260)),i={generateAccessToken:e=>r.default.sign({data:n.default.encrypt(JSON.stringify(e))},o.default.JWT_ACCESS_SECRET,{expiresIn:o.default.JWT_EXPIRE_HOURS}),getTokenData:e=>{try{const t=e.split(" ");if("Bearer"!=t[0])return!1;const a=r.default.verify(t[1],o.default.JWT_ACCESS_SECRET);if(!a||!a.data)return!1;const s=JSON.parse(n.default.decrypt(a.data));return Object.assign({},s)}catch(e){return console.log("error getTokenData: ",e.message),!1}},generateLinkToken:(e,t=o.default.EMAIL_JWT_EXPIRE_HOURSE)=>r.default.sign({data:e},o.default.JWT_ACCESS_SECRET,{expiresIn:t}),getTokenDataLink:e=>{try{const t=r.default.verify(e,o.default.JWT_ACCESS_SECRET);if(!t||"object"!=typeof t||!t.data)return!1;const a=t.data;return Object.assign({},a)}catch(e){return console.log("error getTokenDataLink: ",e.message),!1}}};t.default=i},4572:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.sendSuccess=t.sendError=t.send=void 0;const a=(e,t,a,s,r)=>e.status(r).json({data:t,message:a,error:s});t.send=a,t.sendError=(e,t,s=!1,r=400)=>a(e,s,t,!0,r),t.sendSuccess=(e,t,s=!0,r=200)=>a(e,s,t,!1,r)},7265:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.md5=function(e){return r.default.createHash("md5").update(e).digest("hex")};const r=s(a(8749))},8416:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const s=a(5781);t.default=(e,t)=>(new s.Validator).validate(e,t).valid},7173:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(8456));t.default=r.default},7453:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(8416)),n=s(a(5946)),o=s(a(5260)),i=s(a(8998)),l=s(a(1722)),u=s(a(5560)),d=s(a(3481)),c=o.default.FILE_VEHICLE_PATH,f=o.default.PDF_FILE_PATH;t.default=new class{async createVehicleController(e,t){var a,s;try{if(!(0,r.default)(e.body,i.default.vehicleSchema))return t.status(400).json({message:"Неверный формат"});const{id_type:o,id_brand:u,id_model:d,id_capacity:m,id_box:_,description:g,images:p,id_mass:y,id_bucket:h}=e.body,E=""===m?null:m,v=""===_?null:_,b=""===y?null:y,N=""===h?null:h;if(!Number(null===(a=e.user)||void 0===a?void 0:a.id))return t.status(404).json({message:"У вас нет доступа"});const w=[];if(e.files&&e.files.images){const a=Array.isArray(e.files.images)?e.files.images:[e.files.images];for(const e of a){const a=await n.default.saveFile({path:c,fileName:e.name,sampleFile:e,type:"image"});if(a.error)return t.status(400).json({message:"Ошибка загрузки файла"});w.push(a.dbFileName)}}const T=null===(s=e.files)||void 0===s?void 0:s.pdf_file;if(!T)return t.status(400).json({message:"Файл отсутствует"});const I=Array.isArray(T)?T[0].name:T.name,{dbFileName:O,error:j}=await n.default.saveFile({path:f,fileName:I,sampleFile:Array.isArray(T)?T[0]:T,type:"file",allowTypePrefix:!1});if(j)return t.status(400).json({message:"Не удалось сохранить файл"});const F=await l.default.create(o,u,d,E,v,g,w.length>0?w:p,O,b,N);return F?t.status(200).json({message:"Успешно создано",result:F}):t.status(404).json({message:"Ошибка создания транспортных средств"})}catch(e){return console.error("Ошибка в createController: ",e.message),t.status(500).json({message:"Ошибка сервера"})}}async getVehicleByIdController(e,t){try{const{id:a}=e.query,s=Number(a),r=await l.default.getVehicleById(s);return r?t.status(200).json(r):t.status(404).json({message:"Транспортные средства не найдены"})}catch(e){return console.error("error getNewsController: ",e.message),t.status(500).json({message:"Internal Server Error"})}}async getAllVehicleController(e,t){try{const{id:a}=e.params,{page:s=1,offset:r=12,id_brand:n,id_model:o,id_capacity:i,id_box:u,id_mass:c,id_bucket:f}=e.query,m=e.headers.authorization;let _=!1;const g={};if(m){const e=d.default.getTokenData(m);if(!1===e)return t.status(400).json({message:"Invalid or missing token"});_=(e.r||[]).some((e=>"ADMIN"===e.role_name))}_||(g.active=!0);const p=Number(a),y=Number(s),h=Number(r);if(isNaN(y)||isNaN(h))return t.status(400).json({message:"Некорректные параметры"});n&&(g.id_brand=Number(n)),o&&(g.id_model=Number(o)),i&&(g.id_capacity=Number(i)),u&&(g.id_box=Number(u)),c&&(g.id_mass=Number(c)),f&&(g.id_bucket=Number(f));const E=await l.default.getAllVehicles(p,y,h,g,_);return E?t.status(200).json(E):t.status(404).json({message:"Транспортные средства не найдены"})}catch(e){return console.error("error getAllVehicleController: ",e.message),t.status(500).json({message:"Internal Server Error"})}}async showFile(e,t){try{const a=e.params.fileName,s=f+a,r=await u.default.exists(s);return console.log(await u.default.exists(s)),r?t.sendFile(s):t.status(400).json({message:"Файл не найден"})}catch(e){return console.log("error showFile: ",e.message),t.status(500).json({message:"Ошибка сервера"})}}async showImage(e,t){try{const a=e.params.fileName,s=c+a,r=await u.default.exists(s);return console.log(await u.default.exists(s)),r?t.sendFile(s):t.status(400).json({message:"Файл не найден"})}catch(e){return console.log("error showFile: ",e.message),t.status(500).json({message:"Ошибка сервера"})}}async deleteVehicle(e,t){const{id_vehicle:a}=e.params;return isNaN(Number(a))?t.status(400).json({message:"Неверный формат ID"}):await l.default.deleteVehicleById(Number(a))?t.status(200).json({message:"Успешно удалено"}):t.status(500).json({message:"Ошибка при удалении"})}async updateVehicle(e,t){var a;try{const{id_vehicle:s}=e.params,r=e.body;if(isNaN(Number(s)))return t.status(400).json({message:"Неверный формат ID"});"string"==typeof r.images_to_delete&&(r.images_to_delete=r.images_to_delete.split(",").map((e=>Number(e.trim()))).filter((e=>!isNaN(e))));const o=[];if(e.files&&e.files.images){const a=Array.isArray(e.files.images)?e.files.images:[e.files.images];for(const e of a){const a=await n.default.saveFile({path:c,fileName:e.name,sampleFile:e,type:"image"});if(a.error)return t.status(400).json({message:"Ошибка загрузки изображения"});o.push(a.dbFileName)}}let i=null;const u=null===(a=e.files)||void 0===a?void 0:a.pdf_file;if(u){const e=Array.isArray(u)?u[0].name:u.name,{dbFileName:a,error:s}=await n.default.saveFile({path:f,fileName:e,sampleFile:Array.isArray(u)?u[0]:u,type:"file",allowTypePrefix:!1});if(s)return t.status(400).json({message:"Ошибка обновления PDF-файла"});i=a}return r.images=o.map((e=>({image_name:e}))),i&&(r.pdf_file=i),["id_type","id_brand","id_model","id_capacity","id_box","id_mass","id_bucket"].forEach((e=>{""===r[e]||void 0===r[e]?r[e]=null:(r[e]=Number(r[e]),isNaN(r[e])&&(r[e]=null))})),await l.default.updateVehicleById(Number(s),r)?t.status(200).json({message:"Успешно обновлено"}):t.status(500).json({message:"Ошибка обновления"})}catch(e){return console.error("Error in updateVehicle:",e.message),t.status(500).json({message:"Internal server error"})}}async create(e,t){var a;try{const{id_type:s,id_brand:r,id_model:n,id_capacity:o,id_box:i,description:u,id_mass:d,id_bucket:c,id_fuel:f,id_body:m,power:_,color:g}=e.body,p=""===o?null:o,y=""===i?null:i,h=""===d?null:d,E=""===c?null:c,v=""===f?null:f,b=""===m?null:m,N=""===_?null:_,w=""===g?null:g;if(!Number(null===(a=e.user)||void 0===a?void 0:a.id))return t.status(404).json({message:"У вас нет доступа"});const T=await l.default.saveVehicle(s,r,n,p,y,u,h,E,v,b,N,w);return T?t.status(200).json({message:"Успешно создано",result:T}):t.status(404).json({message:"Ошибка создания транспортных средств"})}catch(e){return console.error("Ошибка в saveVehicleController: ",e.message),t.status(500).json({message:"Ошибка сервера"})}}async update(e,t){try{const{id_vehicle:a}=e.params,{id_type:s,id_brand:r,id_model:n,id_capacity:o,id_box:i,description:u,id_mass:d,id_bucket:c,id_fuel:f,id_body:m,power:_,color:g,active:p}=e.body;return isNaN(Number(a))?t.status(400).json({message:"Неверный формат ID"}):await l.default.updateVehicle(Number(a),s,r,n,o,i,u,d,c,f,m,_,g,p)?t.status(200).json({message:"Успешно обновлено"}):t.status(500).json({message:"Ошибка обновления"})}catch(e){return console.error("Error in updateVehicle:",e.message),t.status(500).json({message:"Internal server error"})}}async addImageController(e,t){try{const{id:a}=e.params,{images:s}=e.body,r=[];if(e.files&&e.files.images){const a=Array.isArray(e.files.images)?e.files.images:[e.files.images];for(const e of a){const a=await n.default.saveFile({path:c,fileName:e.name,sampleFile:e,type:"image"});if(a.error)return t.status(400).json({message:"Ошибка загрузки файла"});r.push(a.dbFileName)}}const o=await l.default.addImage(Number(a),r.length>0?r:s);return o?t.status(200).json({message:"Успешно создано",result:o}):t.status(404).json({message:"Ошибка создания транспортных средств"})}catch(e){return console.error("Ошибка в createController: ",e.message),t.status(500).json({message:"Ошибка сервера"})}}async addFileController(e,t){var a;try{const{id:s}=e.params,r=null===(a=e.files)||void 0===a?void 0:a.pdf_file;if(!r)return t.status(400).json({message:"Файл отсутствует"});const o=Array.isArray(r)?r[0].name:r.name,{dbFileName:i,error:u}=await n.default.saveFile({path:f,fileName:o,sampleFile:Array.isArray(r)?r[0]:r,type:"file",allowTypePrefix:!1});if(u)return t.status(400).json({message:"Не удалось сохранить файл"});const d=await l.default.addFiles(Number(s),i);return d?t.status(200).json({message:"Успешно создано",result:d}):t.status(404).json({message:"Ошибка создания транспортных средств"})}catch(e){return console.error("Ошибка в createController: ",e.message),t.status(500).json({message:"Ошибка сервера"})}}async deleteImage(e,t){const{id_image:a}=e.params;return isNaN(Number(a))?t.status(400).json({message:"Неверный формат ID"}):await l.default.deleteImage(Number(a))?t.status(200).json({message:"Успешно удалено"}):t.status(500).json({message:"Ошибка при удалении"})}async deleteFile(e,t){try{const{id_vehicle:a}=e.params;return isNaN(Number(a))?t.status(400).json({message:"Неверный формат ID"}):await l.default.deleteFile(Number(a))?t.status(200).json({message:"Файл успешно удалён"}):t.status(404).json({message:"Файл не найден или не существует"})}catch(e){return console.error("Error deleting file:",e),t.status(500).json({message:"Ошибка при удалении файла"})}}}},8456:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(7252)),n=s(a(780)),o=s(a(7453)),i=r.default.Router();i.post("/create",n.default.isAdminToken,o.default.create),i.get("/get/id",o.default.getVehicleByIdController),i.get("/get/:id",o.default.getAllVehicleController),i.get("/pdf_file/show/:fileName",o.default.showFile),i.get("/image_file/show/:fileName",o.default.showImage),i.delete("/delete/:id_vehicle",o.default.deleteVehicle),i.put("/update/:id_vehicle",o.default.update),i.post("/add/images/:id",o.default.addImageController),i.post("/add/file/:id",o.default.addFileController),i.delete("/delete/image/:id_image",o.default.deleteImage),i.delete("/delete/file/:id_vehicle",o.default.deleteFile),t.default=i},8998:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default={vehicleSchema:{type:"object",properties:{id_type:{type:"number",minLength:1,required:!0},id_brand:{type:"number",minLength:1,required:!0},id_model:{type:"number",minLength:1,required:!0},id_capacity:{type:"number"},id_box:{type:"number"},description:{type:"string",minLength:6},id_mass:{type:["number","null"]},id_bucket:{type:"number"},id_fuel:{type:"number"},id_power:{type:"number"}}}}},1722:function(e,t,a){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(a(2003)),n=s(a(5260)),o=s(a(4664)),i=s(a(9896)),l=n.default.ALLOW_HOST,u=n.default.PDF_FILE_PATH,d=n.default.PDF_FILE_URL,c=n.default.FILE_VEHICLE_URL,f=n.default.FILE_VEHICLE_PATH,m={create:async function(e,t,a,s,r,n,i,l,u,d){try{const c="",{error:f,rows:m}=await o.default.query("CALL p_insert_vehicle($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11);",[e,t,a,null!=s?s:null,null!=r?r:null,n,i,l,null!=u?u:null,null!=d?d:null,c]);return f?(console.error("Error while inserting post:",f),!1):m}catch(e){return console.error("Error in create:",e.message),!1}},getVehicleById:async function(e){try{const{error:t,rows:a}=await o.default.query("SELECT \n         v.id AS vehicle_id, \n         v.id_type, \n         vt.type_name,\n         v.id_brand, \n         b.brand_name,\n         v.id_model,\n         m.model_name,\n         v.id_capacity,\n         c.capacity_name,\n         v.id_box,\n         bx.box_name,\n         v.id_mass,\n         ms.mass_name,\n         v.id_bucket,\n         bc.bucket_name,\n         v.id_fuel,\n         f.fuel_name,\n         v.id_body,\n         bd.body_name,\n         v.power,\n         v.color,\n         v.description, \n         v.date, \n         v.updated_at, \n         v.active, \n         g.id_image, \n         g.image_name \n       FROM vehicle v \n       LEFT JOIN image g ON v.id = g.id_vehicle\n       LEFT JOIN vehicle_type vt ON vt.id_vehicle_type = v.id_type\n       LEFT JOIN brand b USING(id_brand)\n       LEFT JOIN model m USING(id_model)\n       LEFT JOIN capacity c USING(id_capacity)\n       LEFT JOIN box bx USING(id_box)\n       LEFT JOIN mass ms USING(id_mass)\n       LEFT JOIN bucket bc USING(id_bucket)\n       LEFT JOIN fuel f USING(id_fuel)\n       LEFT JOIN body bd USING(id_body)\n       WHERE v.id = $1;",[e]);return!t&&0!==a.length&&{id:a[0].vehicle_id,id_type:a[0].id_type,type_name:a[0].type_name,id_brand:a[0].id_brand,brand_name:a[0].brand_name,id_model:a[0].id_model,model_name:a[0].model_name,id_capacity:a[0].id_capacity,capacity_name:a[0].capacity_name,id_box:a[0].id_box,box_name:a[0].box_name,id_mass:a[0].id_mass,mass_name:a[0].mass_name,id_bucket:a[0].id_bucket,bucket_name:a[0].bucket_name,id_fuel:a[0].id_fuel,fuel_name:a[0].fuel_name,id_body:a[0].id_body,body_name:a[0].body_name,power:a[0].power,color:a[0].color,description:a[0].description,date:a[0].date,updated_at:a[0].updated_at,active:a[0].active,images:a.map((e=>({id_image:e.id_image,image_name:e.image_name?`${l}${c}image-${e.image_name}`:null})))}}catch(e){return console.log("error getVehicleById: ",e.message),!1}},getAllVehicles:async function(e,t,a,s,r){try{const n=a,i=(t-1)*a;let u="\n      SELECT \n        v.id, \n        v.id_type, \n        vt.type_name,\n        v.id_brand,\n        b.brand_name,\n        v.id_model,\n        m.model_name,\n        v.id_capacity,\n        c.capacity_name,\n        v.id_box,\n        bx.box_name, \n        v.id_mass,\n        mas.mass_name,\n        v.id_bucket,\n        buck.bucket_name,\n        v.id_fuel,\n        f.fuel_name,\n        v.id_body,\n        bd.body_name,\n        v.power,\n        v.color,\n        v.description, \n        v.\"date\", \n        v.updated_at, \n        v.active,\n        ARRAY_AGG(JSON_BUILD_OBJECT('id', i.id_image, 'image_name', i.image_name)) AS images,\n        v.pdf_file\n      FROM vehicle v \n      LEFT JOIN image i ON i.id_vehicle = v.id \n      JOIN vehicle_type vt ON vt.id_vehicle_type = v.id_type \n      JOIN brand b USING(id_brand)\n      JOIN model m USING(id_model)\n      LEFT JOIN capacity c USING(id_capacity)\n      LEFT JOIN \"box\" bx USING(id_box)\n      LEFT JOIN mass mas USING(id_mass)\n      LEFT JOIN bucket buck USING(id_bucket)\n      LEFT JOIN fuel f USING(id_fuel)\n      LEFT JOIN body bd USING(id_body)\n      WHERE v.id_type = $1\n    ";const f=[e];let m="";r||(m+=" AND v.active = true"),s.id_brand&&(m+=` AND v.id_brand = $${f.length+1}`,f.push(s.id_brand)),s.id_model&&(m+=` AND v.id_model = $${f.length+1}`,f.push(s.id_model)),s.id_capacity&&(m+=` AND v.id_capacity = $${f.length+1}`,f.push(s.id_capacity)),s.id_box&&(m+=` AND v.id_box = $${f.length+1}`,f.push(s.id_box)),s.id_mass&&(m+=` AND v.id_mass = $${f.length+1}`,f.push(s.id_mass)),s.id_bucket&&(m+=` AND v.id_bucket = $${f.length+1}`,f.push(s.id_bucket)),u+=m,u+=`\n      GROUP BY v.id,\n               v.id_type,\n               vt.type_name, \n               v.id_brand, \n               b.brand_name, \n               v.id_model, \n               m.model_name, \n               v.id_capacity, \n               c.capacity_name, \n               v.id_box, \n               bx.box_name,\n               v.id_mass,\n               mas.mass_name,\n               v.id_bucket,\n               buck.bucket_name, \n               v.id_fuel,\n               f.fuel_name,\n               v.id_body,\n               bd.body_name,\n               v.power,\n               v.color,\n               v.description, \n               v."date", \n               v.updated_at, \n               v.active,\n               v.pdf_file\n      ORDER BY v.updated_at DESC\n      LIMIT $${f.length+1} OFFSET $${f.length+2};\n    `,f.push(n,i);const _=`\n      SELECT COUNT(*) AS total\n      FROM vehicle v\n      WHERE v.id_type = $1\n      ${m};\n    `,g=[e,...f.slice(1,-2)],{error:p,rows:y}=await o.default.query(_,g);if(p||0===y.length)return!1;const h=parseInt(y[0].total,10),{error:E,rows:v}=await o.default.query(u,f);return!E&&{data:v.map((e=>Object.assign(Object.assign({},e),{pdf_file:e.pdf_file?`${l}${d}${e.pdf_file}`:null,images:e.images.map((e=>Object.assign(Object.assign({},e),{image_name:e.image_name?`${l}${c}image-${e.image_name}`:null})))}))),total:h,currentPage:t,totalPages:Math.ceil(h/n)}}catch(e){return console.log("error getAllVehicles: ",e.message),!1}},deleteVehicleById:async function(e){try{const{rows:t}=await o.default.query("SELECT pdf_file FROM vehicle WHERE id = $1",[e]);if(t.length>0&&t[0].pdf_file){const e=r.default.join(`${u}${t[0].pdf_file}`);i.default.existsSync(e)&&i.default.unlinkSync(e)}const{rows:a}=await o.default.query("SELECT image_name FROM image WHERE id_vehicle = $1",[e]);return a.length>0&&(a.forEach((e=>{const t=r.default.join(`${f}image-${e.image_name}`);i.default.existsSync(t)&&i.default.unlinkSync(t)})),await o.default.query("DELETE FROM image WHERE id_vehicle = $1",[e])),await o.default.query("DELETE FROM vehicle WHERE id = $1",[e]),!0}catch(e){return console.error("Error deleting vehicle, images, or pdf:",e),!1}},updateVehicleById:async function(e,t){try{const{id_type:a,id_brand:s,id_model:n,id_capacity:l,id_box:d,description:c,pdf_file:m,id_mass:_,id_bucket:g,images_to_delete:p}=t,y=!0;let h=null;const{rows:E}=await o.default.query("SELECT pdf_file FROM vehicle WHERE id = $1",[e]);E.length>0&&(h=E[0].pdf_file);let v=[],b=[];if(void 0!==a&&(v.push("id_type = $1"),b.push(a)),void 0!==s&&(v.push("id_brand = $2"),b.push(s)),void 0!==n&&(v.push("id_model = $3"),b.push(n)),void 0!==l&&(v.push("id_capacity = $4"),b.push(l)),void 0!==d&&(v.push("id_box = $5"),b.push(d)),void 0!==c&&(v.push("description = $6"),b.push(c)),void 0!==_&&(v.push("id_mass = $7"),b.push(_)),void 0!==g&&(v.push("id_bucket = $8"),b.push(g)),v.push("active = $9"),b.push(y),v.push("updated_at = NOW()"),await o.default.query(`UPDATE vehicle SET ${v.join(", ")} WHERE id = $${b.length+1}`,[...b,e]),m){if(h&&h!==m){const e=r.default.join(u,h);i.default.existsSync(e)&&i.default.unlinkSync(e)}await o.default.query("UPDATE vehicle SET pdf_file = $1 WHERE id = $2",[m,e])}if(p&&p.length>0){const{rows:e}=await o.default.query("SELECT image_name FROM image WHERE id_image = ANY($1)",[p]);e.forEach((e=>{const t=r.default.join(`${f}image-${e.image_name}`);i.default.existsSync(t)&&i.default.unlinkSync(t)})),await o.default.query("DELETE FROM image WHERE id_image = ANY($1)",[p])}if(t.images&&t.images.length>0){const a=t.images.map((t=>o.default.query("INSERT INTO image (id_vehicle, image_name) VALUES ($1, $2)",[e,t.image_name])));await Promise.all(a)}return!0}catch(e){return console.error("Error updating vehicle and images:",e),!1}},saveVehicle:async function(e,t,a,s,r,n,i,l,u,d,c,f){try{const m="",{error:_,rows:g}=await o.default.query("CALL p_insert_vehicle($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13);",[e,t,a,null!=s?s:null,null!=r?r:null,n,null!=i?i:null,null!=l?l:null,null!=u?u:null,null!=d?d:null,null!=c?c:null,null!=f?f:null,m]);return!_&&g}catch(e){return console.error("Error in saveVehicle:",e.message),!1}},updateVehicle:async function(e,t,a,s,r,n,i,l,u,d,c,f,m,_){try{const g="",{error:p,rows:y}=await o.default.query("CALL p_update_vehicle($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15);",[e,t,a,s,r,n,i,l,u,d,c,f,m,_,g]);return!p&&y}catch(e){return console.error("Error in updateVehicle:",e.message),!1}},addImage:async function(e,t){try{const a="",{error:s,rows:r}=await o.default.query("CALL p_insert_image($1, $2, $3);",[e,t,a]);return!s&&r}catch(e){return console.error("Error in addImage:",e.message),!1}},addFiles:async function(e,t){try{const{error:a,rows:s}=await o.default.query("UPDATE vehicle\n       SET pdf_file = $2\n       WHERE id = $1;",[e,t]);return!a&&s}catch(e){return console.error("Error in addFiles:",e.message),!1}},deleteImage:async function(e){try{const{rows:t}=await o.default.query("SELECT image_name FROM image WHERE id_image = $1",[e]);if(t.length>0){const a=t[0],s=r.default.join(`${f}image-${a.image_name}`);return i.default.existsSync(s)&&i.default.unlinkSync(s),await o.default.query("DELETE FROM image WHERE id_image = $1",[e]),!0}return!1}catch(e){return console.error("Error in deleteImage:",e.message),!1}},deleteFile:async function(e){try{const{rows:t}=await o.default.query("SELECT pdf_file FROM vehicle WHERE id = $1",[e]);if(t.length>0&&t[0].pdf_file){const a=r.default.join(`${u}${t[0].pdf_file}`);return i.default.existsSync(a)&&i.default.unlinkSync(a),await o.default.query("UPDATE vehicle SET pdf_file = NULL WHERE id = $1",[e]),!0}return!1}catch(e){return console.error("Error in deleteFile:",e.message),!1}}};t.default=m},7174:e=>{e.exports=require("compression")},6898:e=>{e.exports=require("cookie-parser")},8577:e=>{e.exports=require("cors")},8749:e=>{e.exports=require("crypto")},818:e=>{e.exports=require("dotenv")},7252:e=>{e.exports=require("express")},6376:e=>{e.exports=require("express-fileupload")},6427:e=>{e.exports=require("i18next")},1889:e=>{e.exports=require("i18next-http-middleware")},8495:e=>{e.exports=require("i18next-node-fs-backend")},5781:e=>{e.exports=require("jsonschema")},829:e=>{e.exports=require("jsonwebtoken")},2003:e=>{e.exports=require("path")},2449:e=>{e.exports=require("pg")},3903:e=>{e.exports=require("uuid")},9896:e=>{e.exports=require("fs")},1725:e=>{e.exports=JSON.parse('{"token":{"notFound":"Токен табылган жок!","invalid":"Токен жараксыз!","permission":"Маалыматты алууга уруксатыңыз жок!","expired":"Токендин мөөнөтү бүттү!","generateError":"Токен жаратуу болбой калды"},"success":"Ийгиликтүү!","error":"Ката!","unauth":"Логин же сырсөз туура эмес!","inValidFormat":"Маалыматтарды туура толтуруңуз!","noValidEmail":"Электрондук дарек туура эмес!","noToken":"Токен жок!","emailUsed":"Email колдонууда","userNotFound":"Колдонуучу табылган жок","emailAlreadyInUse":"Сиз мурунтан эле колдонуп жаткан электрондук почтага өзгөртө албайсыз","changedNumber":"Телефон номери ийгиликтүү өзгөртүлдү","couldNotChangeTheNumber":"Номерди өзгөртүү ишке ашкан жок","phoneAlreadyInUse":"Сиз мурунтан эле колдонуп жаткан телефон номерге өзгөртө албайсыз","passwordAlreadyInUse":"Сиз мурунтан эле колдонуп жүргөн сырсөздү алмаштыра албайсыз","changePassword":"Сырсөздү ийгиликтүү өзгөрттүңүз","couldNotChangeThePassword":"Сырсөз өзгөргөн жок","fileIsMissing":"Файл жок","fileNotFound":"Файл табылган жок!"}')},970:e=>{e.exports=JSON.parse('{"token":{"notFound":"Токен не найден!","invalid":"Токен недействительный!","permission":"У вас нет доступа!","expired":"Срок действия токена истек!","generateError":"Не удалось сгенерировать токен"},"success":"Успешно!","error":"Ошибка!","unauth":"Неправильный логин пароль!","inValidFormat":"Неверный формат данных!","noValidEmail":"Неверный адрес электронной почты!","noToken":"Нет токена!","emailUsed":"Email уже используется","userNotFound":"Пользователь не найден","emailAlreadyInUse":"Нельзя поменять на почту, которую вы уже используете","changedNumber":"Номер телефона успешно изменен","couldNotChangeTheNumber":"Не получилось изменить номер","phoneAlreadyInUse":"Нельзя поменять на номер, которую вы уже используете","passwordAlreadyInUse":"Нельзя поменять на тот же пароль, которую вы уже используете","changePassword":"Вы успешно поменяли пароль","couldNotChangeThePassword":"Не получилось поменять пароль","fileIsMissing":"Файл отсутствует","fileNotFound":"Файл не найден!"}')}},t={},a=function a(s){var r=t[s];if(void 0!==r)return r.exports;var n=t[s]={exports:{}};return e[s].call(n.exports,n,n.exports,a),n.exports}(7806);app=a})();